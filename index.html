<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Gym Tracker V104 Touch Fix</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2d3436">
    <link rel="apple-touch-icon" href="icon.png">

    <style>
        /* --- VARIABLES --- */
        :root { --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #2d3436; --text-gray: #636e72; --input-bg: #f1f3f5; --shadow: 0 4px 20px rgba(0,0,0,0.04); --btn-default-bg: #e9ecef; --btn-default-text: #495057; --brand: #2d3436; --highlight: #ffeaa7; --accent-green: #00b894; --glass-bg: rgba(255, 255, 255, 0.7); --glass-border: rgba(255, 255, 255, 0.5); --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15); }
        
        /* GENERAL & RESET */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 15px; padding-bottom: 120px; -webkit-font-smoothing: antialiased; overscroll-behavior-y: contain; overflow-x: hidden; user-select: none; /* Global selection off for better app feel */ }
        h1 { text-align: center; margin-bottom: 30px; font-weight: 900; text-transform: uppercase; font-size: 1.4rem; letter-spacing: -0.5px; animation: fadeInDown 0.5s ease; }
        
        .container { max-width: 600px; margin: 0 auto; position: relative; }
        .hidden { display: none !important; }
        
        /* --- ANIMATIONS --- */
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
        .anim-right { animation: slideInRight 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        .anim-left { animation: slideInLeft 0.3s cubic-bezier(0.25, 1, 0.5, 1) forwards; }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); } }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(2deg); } 75% { transform: rotate(-2deg); } 100% { transform: rotate(0deg); } }

        /* --- INPUTS & SELECTS --- */
        select { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid transparent; background: #fff; font-size: 1rem; margin-bottom: 25px; font-weight: 700; outline: none; text-align: center; text-align-last: center; box-shadow: var(--shadow); -webkit-appearance: none; appearance: none; cursor: pointer; transition: transform 0.1s; }
        select:active { transform: scale(0.98); }
        .input-wrapper { position: relative; flex: 1; min-width: 0; }
        input { width: 100%; padding: 14px; padding-right: 35px; background: var(--input-bg); border: 2px solid transparent; border-radius: 16px; font-weight: 600; font-size: 16px; color: var(--text-main); transition: 0.3s; user-select: text; /* Allow text selection in inputs */ }
        input:focus { outline: none; background: #fff; border-color: #dfe6e9; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .unit-label { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; font-weight: 700; color: #b2bec3; pointer-events: none; }

        /* --- BOUTONS --- */
        button, .btn-finish-exo, .hist-category-btn, .prog-item, .cal-day, .nav-item { cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); user-select: none; }
        button:active, .btn-finish-exo:active, .hist-category-btn:active, .prog-item:active, .cal-day:active, .nav-item:active { transform: scale(0.95); opacity: 0.8; }
        button { border: none; font-weight: 700; border-radius: 16px; position: relative; overflow: hidden; }
        .btn-primary { width: 100%; padding: 15px; background: var(--text-main); color: #fff; font-size: 1rem; margin-top: 15px; }
        .btn-add { width: 100%; padding: 12px; background: #fff; border: 2px solid #f1f3f5; color: var(--text-main); margin-top: 5px; font-size: 0.9rem;}
        .btn-add:hover { border-color: #dee2e6; background: #f8f9fa; }
        .btn-add-superset { background: #ffeaa7; color: #d35400; padding: 12px; width: 100%; margin-top:10px; font-size: 0.9rem;}
        .btn-danger { background: #ff6b6b; color: white; padding: 8px 16px; font-size: 0.8rem; border-radius: 14px; }
        .btn-cancel { background: transparent; color: #636e72; padding: 10px; width: 100%; margin-top: 5px; font-size: 0.8rem; }
        .btn-edit { background: #fff; color: #2d3436; border: 1px solid #dfe6e9; padding: 8px 16px; font-size: 0.8rem; border-radius: 14px; margin-right:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .btn-finish-exo { width: 100%; padding: 16px; background-color: var(--btn-default-bg); color: var(--btn-default-text); font-size: 0.95rem; margin-top: 15px; border:none; border-radius: 16px; display:block; text-align:center;}
        .btn-finish-exo.validated { color: #fff !important; cursor: default; transform: none; box-shadow: none; }
        .btn-terminate-session { width: 100%; padding: 18px; background-color: var(--brand); color: #fff; font-size: 1.1rem; margin-top: 40px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; border-radius: 20px; box-shadow: 0 10px 20px rgba(45, 52, 54, 0.15); }

        /* --- CARDS & HEADER --- */
        .card { background: var(--bg-card); border-radius: 24px; box-shadow: var(--shadow); margin-bottom: 25px; padding: 20px; border-left: 10px solid #333; animation: fadeInUp 0.4s ease backwards; }
        .card-header { display: flex; flex-direction: column; gap:8px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f1f1; }
        .header-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; flex-wrap: wrap; }
        .exo-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); flex: 1; min-width: 150px; line-height: 1.3; }
        .exo-badge { background: var(--input-bg); color: var(--text-gray); font-size: 0.75rem; font-weight: 600; padding: 6px 12px; border-radius: 12px; white-space: nowrap; flex-shrink: 0; align-self: flex-start; }
        .card.superset-container { border: 1px solid #eee; border-left-width: 10px; border-left-style: solid; }
        .superset-label { font-size: 0.7rem; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 15px; display: block; text-align: center; color: #fff; padding: 5px 0; border-radius: 20px; width: 100px; margin: 0 auto 20px auto; }
        .set-block { border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .set-block:last-child { border-bottom: none; margin-bottom: 0; }
        .serie-container { margin-bottom: 12px; }
        .input-row { display: flex; align-items: center; gap: 10px; width: 100%; }
        .set-col { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 35px; flex-shrink: 0; gap: 4px; }
        .set-num { font-weight: 700; color: #ced4da; font-size: 0.85rem; }
        .btn-mini-add { width: 20px; height: 20px; border-radius: 50%; background: #e9ecef; color: #636e72; border: none; font-size: 16px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
        .drop-row { margin-top: 8px; animation: fadeInUp 0.3s ease; }
        .drop-icon { font-size: 1.2rem; font-weight: 900; cursor: pointer; color: var(--card-color); }
        .last-perf { font-size: 0.75rem; color: #b2bec3; font-weight: 600; margin-top: 4px; margin-left: 45px; display: block; width: 100%; }

        /* --- CALENDRIER --- */
        .calendar-wrapper { background: #fff; border-radius: 24px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; animation: fadeInUp 0.4s ease; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-cal-nav { background: var(--input-bg); color: var(--text-main); width: 36px; height: 36px; border-radius: 50%; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-bottom: 10px; text-align: center; }
        .cal-weekday { font-size: 0.8rem; font-weight: 700; color: #b2bec3; text-transform: uppercase; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { aspect-ratio: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-weight: 600; font-size: 0.9rem; position: relative; background: #f8f9fa; color: #b2bec3; border: 2px solid transparent; }
        .cal-day.active-month { background: #fff; color: var(--text-main); border-color: #f1f3f5; }
        .cal-day.selected { background: #dfe6e9 !important; color: var(--text-main) !important; border-color: #b2bec3 !important; }
        .cal-day.has-session::after { content: ''; width: 6px; height: 6px; background: var(--accent-green); border-radius: 50%; position: absolute; bottom: 6px; transition: 0.2s; }
        .cal-day.today { border: 2px solid var(--highlight) !important; color: var(--text-main) !important; }
        .session-item-detail { background: #fff; padding: 15px; border-radius: 16px; margin-bottom: 10px; border-left: 5px solid var(--accent-green); box-shadow: 0 2px 5px rgba(0,0,0,0.03); display: flex; justify-content: space-between; align-items: center; animation: fadeInUp 0.3s ease; }
        .session-item-detail span { font-weight: 700; color: var(--text-main); }

        /* BUILDER & HISTO */
        .builder-btn { width: 100%; padding: 20px; background: #fff; color: var(--text-main); box-shadow: var(--shadow); margin-bottom: 25px; border-radius: 24px; font-size:1rem; border: 1px solid transparent; }
        #builderArea { background: #fff; padding: 25px; border-radius: 24px; margin-bottom: 20px; box-shadow: var(--shadow); animation: fadeInUp 0.3s ease; }
        .builder-block { background:#f8f9fa; padding:15px; border-radius: 16px; margin-bottom:10px; border:1px solid #eee; }
        .builder-row { display: flex; gap: 15px; margin-bottom: 10px; }
        .builder-label { font-size: 0.8rem; font-weight: 700; color: #b2bec3; margin-bottom: 5px; display: block; text-transform: uppercase; }
        .builder-item { background: #f8f9fa; border: 1px solid #eee; border-radius: 16px; margin-bottom: 10px; padding: 15px 40px 15px 15px; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .builder-item.editing-active { border: 2px solid #fdcb6e; background-color: #fffbf0; transform: scale(1.02); }
        .delete-x { position: absolute; top: 12px; right: 15px; color: #ff6b6b; font-weight: 900; font-size: 1.1rem; padding: 5px; }
        .builder-exo-name { display: block; font-weight: 800; font-size: 1rem; color: #2d3436; margin-bottom: 4px; }
        .builder-exo-info { display: block; font-size: 0.85rem; font-weight: 600; color: #636e72; }

        .prog-item { background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        .prog-title { font-weight: 800; font-size: 1.1rem; color: #2d3436; }
        .prog-header-actions { display: flex; gap: 5px; }
        .prog-details-box { padding: 20px; background: #fff; margin-bottom: 20px; border-radius: 24px; box-shadow: var(--shadow); display: none; }
        .prog-details-box.open { display: block; animation: fadeInUp 0.3s ease-out; }
        .exo-wrapper, .superset-wrapper { border-radius: 16px; overflow: hidden; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .prog-line { display: flex; justify-content: space-between; align-items: center; padding: 16px 15px; border-left-width: 6px; border-left-style: solid; background: transparent; }
        .prog-line-name { font-weight: 700; color: #2d3436; font-size: 0.95rem; }
        .prog-line-info { color: #636e72; font-size: 0.85rem; font-weight: 600; }

        .hist-category-btn { background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 24px; box-shadow: var(--shadow); display: flex; justify-content: space-between; align-items: center; animation: fadeInUp 0.3s ease backwards; }
        .hist-cat-title { font-weight: 800; font-size: 1.1rem; color: var(--text-main); }
        .hist-count { background: var(--input-bg); color: #636e72; padding: 5px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; }
        .btn-back-hist { display: inline-block; margin-bottom: 15px; font-weight: 700; color: var(--text-gray); background: var(--input-bg); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; }
        .hist-session { background: #fff; border-radius: 24px; margin-bottom: 15px; box-shadow: var(--shadow); overflow: hidden; animation: fadeInUp 0.3s ease backwards; }
        .hist-header { padding: 20px; cursor: pointer; display: flex; align-items: center; background: #fff; }
        .hist-date-large { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
        .hist-body { display: none; padding: 0 20px 20px; border-top: 1px solid #f1f3f5; }
        .hist-body.open { display: block; }
        .hist-exo-line { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .hist-exo-name { font-weight: 700; color: #2d3436; }
        .hist-exo-perf { color: #636e72; text-align: right; }

        .backup-area { margin-top: 40px; padding-top: 20px; border-top: 2px dashed #e9ecef; text-align: center; }
        .btn-backup { background: #00b894; color: white; width: 100%; padding: 12px; margin-bottom: 10px; font-size: 0.9rem; }
        .btn-restore { background: #636e72; color: white; width: 100%; padding: 12px; font-size: 0.9rem; }

        .nav-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: #fff; padding: 15px; border-radius: 30px; display: flex; justify-content: space-around; box-shadow: 0 10px 40px rgba(0,0,0,0.08); z-index: 999; }
        .nav-item { background: transparent; color: #adb5bd; font-size: 0.9rem; font-weight: 700; border: none; }
        .nav-item.active { color: var(--text-main); transform: scale(1.1); }

        /* --- V102 FIXED DRAGGABLE TIMER STYLES --- */
        #floatingTimerBtn {
            position: fixed; bottom: 100px; right: 20px;
            width: auto; padding: 12px 20px; height: auto; border-radius: 30px;
            
            /* GLASS EFFECT */
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(25px) saturate(150%);
            -webkit-backdrop-filter: blur(25px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            color: var(--text-main);
            
            display: flex; align-items: center; justify-content: center;
            font-size: 1.1rem; font-weight: 800; z-index: 1000;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
            
            /* IMPORTANT: Only transition visuals, not position */
            transition: background 0.3s, box-shadow 0.3s, color 0.3s, transform 0.2s;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }

        #floatingTimerBtn.active {
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.25), inset 0 0 15px rgba(255,255,255,0.1);
        }

        #floatingTimerBtn.alert { 
            background: rgba(255, 107, 107, 0.8); color:#fff; border:none; 
            animation: pulse 1s infinite; text-shadow: none;
        }

        #timerPanel {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #fff; border-radius: 30px 30px 0 0;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.15);
            z-index: 1001; padding: 25px; transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
        }
        #timerPanel.open { transform: translateY(0); }
        .timer-display { font-size: 3.5rem; font-weight: 900; color: var(--text-main); font-variant-numeric: tabular-nums; margin-bottom: 20px; }
        
        .timer-controls { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .timer-btn-round { width: 50px; height: 50px; border-radius: 50%; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; background: #f1f3f5; color: var(--text-main); }
        .timer-btn-round.play { background: rgba(45, 52, 54, 0.8); backdrop-filter: blur(5px); color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .timer-btn-round.reset { background: #ffeaa7; color: #d35400; font-size: 1.1rem; }

        /* V100 CUSTOM PRESETS STYLES */
        .timer-presets-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .timer-presets-header span { font-size: 0.85rem; font-weight: 700; color: #b2bec3; text-transform: uppercase; }
        
        /* Boutons Actions (Fix V102) */
        .btn-icon-action { width: 32px; height: 32px; border-radius: 50%; border:none; display:flex; align-items:center; justify-content:center; font-weight:900; font-size:1rem; cursor:pointer; transition:0.2s; }
        
        #btnEditPresets { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); font-size: 0.9rem; } /* Croix */
        #btnEditPresets.active { background: #ff6b6b; color: white; box-shadow: 0 4px 10px rgba(255, 107, 107, 0.3); }
        
        /* Ajustement taille font pour le + pour matcher la croix visuellement */
        #btnAddPreset { color: #00b894; background: rgba(0, 184, 148, 0.1); font-size: 1.2rem; } /* Plus gros */
        #btnAddPreset:active { transform: scale(0.9); }
        
        .timer-presets-scroll { 
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; 
            -webkit-overflow-scrolling: touch; scrollbar-width: none; 
        }
        .timer-presets-scroll::-webkit-scrollbar { display: none; }
        
        .btn-preset { 
            flex: 0 0 auto; min-width: 70px; padding: 12px 0; border-radius: 12px; 
            background: #f8f9fa; color: #636e72; font-weight: 700; font-size: 0.9rem; 
            position: relative; transition: 0.2s;
        }
        /* Effet shake quand suppression activée */
        .btn-preset.shake { animation: shake 0.3s infinite; background: #fff0f0; color: #ff6b6b; border: 1px dashed #ff6b6b; }

        .overlay-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .overlay-backdrop.show { opacity: 1; pointer-events: auto; }
    </style>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch((err) => console.log(err));
      }
    </script>
</head>
<body>

<div class="container">
    <h1 id="mainTitle">Ma Séance</h1>

    <div id="view-seance" class="app-view">
        <select id="selectProgram" onchange="chargerInterface()">
            <option value="" disabled selected>Choisir une Séance</option>
        </select>
        <div id="zoneTravail"></div>
        <div id="zoneFinSeance"></div>
    </div>

    <div id="view-progs" class="app-view hidden">
        <button class="builder-btn" onclick="toggleBuilder()">Créer une Séance</button>
        <div id="builderArea" class="hidden">
            <h3 style="margin-top:0">Nouvelle Séance</h3>
            <input type="text" id="newProgName" placeholder="Nom de la séance" style="margin-bottom:15px;">
            <div class="builder-block">
                <span id="labelExoA" class="builder-label hidden">Exercice A (Principal)</span>
                <input type="text" id="buildExoName" placeholder="Nom de l'exercice" style="margin-bottom:10px;">
                <div class="builder-row">
                    <input type="number" id="buildSeries" placeholder="Séries" min="1">
                    <input type="text" id="buildReps" placeholder="Reps (ex: 10-12)">
                </div>
            </div>
            <div id="blockExoB" class="builder-block hidden">
                <span class="builder-label">Exercice B (Superset)</span>
                <input type="text" id="buildExoNameB" placeholder="Nom du 2ème exercice" style="margin-bottom:10px;">
                <div class="builder-row">
                    <input type="number" id="buildSeriesB" placeholder="Séries" min="1">
                    <input type="text" id="buildRepsB" placeholder="Reps (ex: 10-12)">
                </div>
            </div>
            <div id="builderButtons">
                <div id="btnGroupNormal">
                    <button id="btnAddNormal" class="btn-add" onclick="ajouterExoAuBuilder()">Ajouter</button>
                    <button id="btnAddSupersetSwitch" class="btn-add-superset" onclick="activerModeSuperset()">Ajouter un Superset</button>
                </div>
                <div id="btnGroupSuperset" class="hidden">
                    <button id="btnAddSupersetConfirm" class="btn-add-superset" style="background:#2d3436; color:#fff;" onclick="validerSupersetBuilder()">Valider le Superset</button>
                    <button class="btn-cancel" onclick="annulerModeSuperset()">Annuler le Superset</button>
                </div>
            </div>
            <div id="builderListDisplay" style="margin-bottom:15px; margin-top:15px;"></div>
            <button id="btnSaveProg" class="btn-primary" onclick="sauvegarderProgrammeFinal()">Sauvegarder la Séance</button>
        </div>
        <div id="listeMesProgrammes"></div>
    </div>

    <div id="view-history" class="app-view hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
            <h3 id="histMainTitle" style="margin:0; text-transform:uppercase;">Types de Séances</h3>
            <button id="histActionBtn" class="btn-danger" onclick="resetHistoryOnly()">Effacer toutes les Séances</button>
        </div>
        <div id="listeHistorique"></div>
        <div class="backup-area">
            <h4 style="margin-top:0; color:#b2bec3;">GESTION DES DONNÉES</h4>
            <button class="btn-backup" onclick="exportData()">Sauvegarder mes données</button>
            <button class="btn-restore" onclick="triggerImport()">Importer une sauvegarde</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)">
        </div>
    </div>

    <div id="view-calendar" class="app-view hidden">
        <h3 style="margin-top:0; text-transform:uppercase; text-align:center; margin-bottom:20px;">Calendrier</h3>
        <div class="calendar-wrapper">
            <div class="calendar-header">
                <button class="btn-cal-nav" onclick="changeMonth(-1)">&#10094;</button>
                <span id="calMonthDisplay" style="font-weight:800; font-size:1.1rem; text-transform:capitalize;"></span>
                <button class="btn-cal-nav" onclick="changeMonth(1)">&#10095;</button>
            </div>
            <div class="calendar-weekdays">
                <div class="cal-weekday">Lun</div><div class="cal-weekday">Mar</div><div class="cal-weekday">Mer</div><div class="cal-weekday">Jeu</div><div class="cal-weekday">Ven</div><div class="cal-weekday">Sam</div><div class="cal-weekday">Dim</div>
            </div>
            <div id="calendarGrid" class="calendar-grid"></div>
        </div>
        <div id="calendarDetails" style="margin-top:20px;">
            <h4 style="color:#b2bec3; font-size:0.9rem; text-transform:uppercase;">Détails du jour</h4>
            <div id="daySessionsList" style="margin-top:10px; color:#636e72;">Cliquez sur un jour pour voir les détails.</div>
        </div>
    </div>
</div>

<div id="overlayBackdrop" class="overlay-backdrop" onclick="toggleTimerPanel()"></div>
<button id="floatingTimerBtn" oncontextmenu="event.preventDefault(); return false;">01:30</button>
<div id="timerPanel">
    <div style="width:40px; height:4px; background:#e9ecef; border-radius:2px; margin:0 auto 20px auto;"></div>
    <div class="timer-display" id="timerDisplay">01:30</div>
    <div class="timer-controls">
        <button class="timer-btn-round" onclick="adjustTime(-30)">-30</button>
        <button class="timer-btn-round reset" id="resetBtn" onclick="resetTimer()" style="display:none;">↺</button> 
        <button class="timer-btn-round play" id="playPauseBtn" onclick="toggleTimerState()">▶</button>
        <button class="timer-btn-round" onclick="adjustTime(30)">+30</button>
    </div>
    
    <div class="timer-presets-header">
        <span>Mes Temps</span>
        <div style="display:flex; gap:10px;">
            <button id="btnEditPresets" class="btn-icon-action" onclick="toggleEditPresets()">✖</button>
            <button id="btnAddPreset" class="btn-icon-action" onclick="addCustomPreset()">+</button>
        </div>
    </div>
    <div class="timer-presets-scroll" id="presetContainer">
        </div>
</div>

<nav class="nav-bar">
    <button class="nav-item active" onclick="switchTab('seance', this, 0)">Séance</button>
    <button class="nav-item" onclick="switchTab('progs', this, 1)">Programme</button>
    <button class="nav-item" onclick="switchTab('history', this, 2)">Historique</button>
    <button class="nav-item" onclick="switchTab('calendar', this, 3)">Calendrier</button>
</nav>

<script>
    let DB = {
        progs: JSON.parse(localStorage.getItem('gym_v8_progs')) || {},
        history: JSON.parse(localStorage.getItem('gym_v21_history')) || []
    };
    
    // PRESETS STORAGE
    let timerPresets = JSON.parse(localStorage.getItem('gym_timer_presets')) || [60, 90, 120, 180];
    let isEditingPresets = false;

    let currentSessionLogs = [];
    let tempBuilderList = [];
    let currentEditingIndex = -1; 
    let currentCalDate = new Date(); 
    let currentTabIndex = 0; 
    
    let timerInterval = null;
    let timeRemaining = 90; 
    let lastDuration = 90; 
    let isTimerRunning = false;

    // DRAG VARIABLES (V104)
    const floatBtn = document.getElementById('floatingTimerBtn');
    let isDragging = false;
    let startX, startY;
    let dragStartTime = 0;

    const allColors = ['#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#E0BBE4', '#FF9AA2', '#957DAD'];
    let colorBag = [];
    let historyState = { view: 'categories', selected: null }; 

    function getNextColor() {
        if (colorBag.length === 0) colorBag = [...allColors];
        const randomIndex = Math.floor(Math.random() * colorBag.length);
        const selected = colorBag[randomIndex];
        colorBag.splice(randomIndex, 1);
        return selected;
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateSelectMenu();
        renderProgramList();
        renderHistory();
        renderCalendar();
        initSortable();
        updateTimerDisplay(); // V101: Will set initial text on float button
        initDrag();
        renderPresets(); 
    });

    // --- V100 PRESETS LOGIC ---
    function renderPresets() {
        const container = document.getElementById('presetContainer');
        container.innerHTML = '';
        timerPresets.forEach((seconds, index) => {
            const btn = document.createElement('button');
            btn.className = 'btn-preset' + (isEditingPresets ? ' shake' : '');
            btn.innerHTML = formatTime(seconds);
            btn.onclick = () => handlePresetClick(seconds, index);
            container.appendChild(btn);
        });
    }

    function handlePresetClick(seconds, index) {
        if (isEditingPresets) {
            if(confirm("Supprimer ce temps ?")) {
                timerPresets.splice(index, 1);
                localStorage.setItem('gym_timer_presets', JSON.stringify(timerPresets));
                renderPresets();
                if(timerPresets.length === 0) toggleEditPresets(); 
            }
        } else {
            setTimer(seconds);
        }
    }

    function addCustomPreset() {
        const input = prompt("Entrez le temps (ex: 1:30 ou 90)");
        if (input) {
            let seconds = 0;
            if (input.includes(':')) {
                const parts = input.split(':');
                seconds = (parseInt(parts[0]) * 60) + parseInt(parts[1]);
            } else {
                seconds = parseInt(input);
            }
            
            if (seconds > 0 && !isNaN(seconds)) {
                timerPresets.push(seconds);
                timerPresets.sort((a,b) => a - b); 
                localStorage.setItem('gym_timer_presets', JSON.stringify(timerPresets));
                renderPresets();
            } else {
                alert("Format invalide !");
            }
        }
    }

    function toggleEditPresets() {
        isEditingPresets = !isEditingPresets;
        document.getElementById('btnEditPresets').classList.toggle('active');
        renderPresets();
    }

    // --- DRAG LOGIC (V104 FIX) ---
    function initDrag() {
        floatBtn.addEventListener('touchstart', (e) => {
            const touch = e.touches[0];
            const rect = floatBtn.getBoundingClientRect();
            
            isDragging = false; 
            dragStartTime = new Date().getTime(); // Record time
            
            startX = touch.clientX - rect.left;
            startY = touch.clientY - rect.top;
            
            // Record original click position
            floatBtn.setAttribute('data-start-x', touch.clientX);
            floatBtn.setAttribute('data-start-y', touch.clientY);
        }, {passive: false});

        floatBtn.addEventListener('touchmove', (e) => {
            e.preventDefault(); 
            const touch = e.touches[0];
            
            // Only consider it a drag if moved > 5px (debounce)
            const originalX = parseFloat(floatBtn.getAttribute('data-start-x'));
            const originalY = parseFloat(floatBtn.getAttribute('data-start-y'));
            const dist = Math.hypot(touch.clientX - originalX, touch.clientY - originalY);
            
            if (dist > 5) {
                isDragging = true;
                let x = touch.clientX - startX;
                let y = touch.clientY - startY;
                
                const maxX = window.innerWidth - floatBtn.offsetWidth;
                const maxY = window.innerHeight - floatBtn.offsetHeight;
                
                if(x < 0) x = 0; if(x > maxX) x = maxX;
                if(y < 0) y = 0; if(y > maxY) y = maxY;
                
                floatBtn.style.left = x + 'px';
                floatBtn.style.top = y + 'px';
                floatBtn.style.right = 'auto';
                floatBtn.style.bottom = 'auto';
            }
        }, {passive: false});

        floatBtn.addEventListener('touchend', (e) => {
            // Check time duration of touch
            const touchDuration = new Date().getTime() - dragStartTime;
            
            // If it wasn't a drag AND touch was quick (< 300ms) = Tap
            if (!isDragging && touchDuration < 300) {
                toggleTimerPanel();
            }
            
            // Reset flags
            isDragging = false;
        });

        // Mouse Support
        floatBtn.addEventListener('mousedown', (e) => {
            isDragging = true;
            const rect = floatBtn.getBoundingClientRect();
            startX = e.clientX - rect.left;
            startY = e.clientY - rect.top;
            floatBtn.setAttribute('data-start-x', e.clientX);
            floatBtn.setAttribute('data-start-y', e.clientY);
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                e.preventDefault();
                let x = e.clientX - startX;
                let y = e.clientY - startY;
                const maxX = window.innerWidth - floatBtn.offsetWidth;
                const maxY = window.innerHeight - floatBtn.offsetHeight;
                if(x < 0) x = 0; if(x > maxX) x = maxX;
                if(y < 0) y = 0; if(y > maxY) y = maxY;
                floatBtn.style.left = x + 'px';
                floatBtn.style.top = y + 'px';
                floatBtn.style.right = 'auto';
                floatBtn.style.bottom = 'auto';
            }
        });

        document.addEventListener('mouseup', (e) => {
            if (isDragging) {
                const originalX = parseFloat(floatBtn.getAttribute('data-start-x'));
                const originalY = parseFloat(floatBtn.getAttribute('data-start-y'));
                const dist = Math.hypot(e.clientX - originalX, e.clientY - originalY);
                if (dist < 5) toggleTimerPanel();
                isDragging = false;
            }
        });
    }

    // --- TIMER LOGIC ---
    function toggleTimerPanel() {
        const panel = document.getElementById('timerPanel');
        const backdrop = document.getElementById('overlayBackdrop');
        const isClosed = !panel.classList.contains('open');
        if (isClosed) { panel.classList.add('open'); backdrop.classList.add('show'); } 
        else { panel.classList.remove('open'); backdrop.classList.remove('show'); if(isEditingPresets) toggleEditPresets(); }
    }

    function formatTime(seconds) {
        const m = Math.floor(seconds / 60).toString().padStart(2, '0');
        const s = (seconds % 60).toString().padStart(2, '0');
        return `${m}:${s}`;
    }

    function updateTimerDisplay() {
        const display = document.getElementById('timerDisplay');
        const resetBtn = document.getElementById('resetBtn');
        const formatted = formatTime(timeRemaining);
        display.innerText = formatted;
        floatBtn.innerText = formatted; 
        
        if (isTimerRunning) {
            floatBtn.classList.add('active'); 
            document.getElementById('playPauseBtn').innerText = "⏸";
            resetBtn.style.display = "none"; 
        } else {
            floatBtn.classList.remove('active');
            document.getElementById('playPauseBtn').innerText = "▶";
            resetBtn.style.display = "flex"; 
        }

        if (timeRemaining === 0) {
            floatBtn.classList.add('alert'); display.style.color = "#ff6b6b";
            if(navigator.vibrate) navigator.vibrate([200, 100, 200]);
        } else {
            floatBtn.classList.remove('alert'); display.style.color = "var(--text-main)";
        }
    }

    function toggleTimerState() {
        if (isTimerRunning) {
            clearInterval(timerInterval);
            isTimerRunning = false;
        } else {
            if (timeRemaining <= 0) timeRemaining = lastDuration; 
            isTimerRunning = true;
            timerInterval = setInterval(() => {
                if (timeRemaining > 0) { timeRemaining--; updateTimerDisplay(); } 
                else { clearInterval(timerInterval); isTimerRunning = false; updateTimerDisplay(); }
            }, 1000);
        }
        updateTimerDisplay();
    }

    function resetTimer() {
        clearInterval(timerInterval);
        isTimerRunning = false;
        timeRemaining = lastDuration; 
        updateTimerDisplay();
    }

    function setTimer(seconds) {
        clearInterval(timerInterval);
        isTimerRunning = true; 
        timeRemaining = seconds;
        lastDuration = seconds; 
        updateTimerDisplay();
        timerInterval = setInterval(() => {
            if (timeRemaining > 0) { timeRemaining--; updateTimerDisplay(); } 
            else { clearInterval(timerInterval); isTimerRunning = false; updateTimerDisplay(); }
        }, 1000);
    }

    function adjustTime(seconds) {
        timeRemaining += seconds;
        if (timeRemaining < 0) timeRemaining = 0;
        lastDuration = timeRemaining; 
        updateTimerDisplay();
    }

    // --- NAVIGATION ---
    function switchTab(viewName, btn, newIndex) {
        if (newIndex === currentTabIndex) return;
        const direction = newIndex > currentTabIndex ? 'right' : 'left';
        currentTabIndex = newIndex;
        const views = document.querySelectorAll('.app-view');
        views.forEach(v => { v.classList.add('hidden'); v.classList.remove('anim-right', 'anim-left'); });
        const newView = document.getElementById('view-' + viewName);
        newView.classList.remove('hidden');
        newView.classList.add(direction === 'right' ? 'anim-right' : 'anim-left');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const titleEl = document.getElementById('mainTitle');
        if(viewName === 'seance') titleEl.innerText = "Ma Séance";
        if(viewName === 'progs') titleEl.innerText = "Mon Programme";
        if(viewName === 'history') titleEl.innerText = "Mon Historique";
        if(viewName === 'calendar') { titleEl.innerText = "Mon Calendrier"; renderCalendar(); }
    }

    // --- CALENDRIER ---
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const monthDisplay = document.getElementById('calMonthDisplay');
        grid.innerHTML = '';
        const year = currentCalDate.getFullYear();
        const month = currentCalDate.getMonth();
        const monthNames = ["Janvier", "Février", "Mars", "Avril", "Mai", "Juin", "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"];
        monthDisplay.innerText = `${monthNames[month]} ${year}`;
        const firstDayOfMonth = new Date(year, month, 1).getDay(); 
        let adjustedFirstDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < adjustedFirstDay; i++) {
            const emptyCell = document.createElement('div');
            grid.appendChild(emptyCell);
        }
        const today = new Date();
        for (let d = 1; d <= daysInMonth; d++) {
            const cell = document.createElement('div');
            cell.className = 'cal-day active-month';
            cell.innerText = d;
            const cellDateObj = new Date(year, month, d);
            const cellDateStr = cellDateObj.toLocaleDateString(); 
            if (d === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                cell.classList.add('today');
            }
            const hasSession = DB.history.some(s => s.date === cellDateStr);
            if (hasSession) {
                cell.classList.add('has-session');
            }
            cell.onclick = () => {
                document.querySelectorAll('.cal-day').forEach(c => c.classList.remove('selected'));
                cell.classList.add('selected');
                showDayDetails(cellDateStr);
            };
            grid.appendChild(cell);
        }
    }
    function changeMonth(delta) { currentCalDate.setMonth(currentCalDate.getMonth() + delta); renderCalendar(); }
    function showDayDetails(dateStr) {
        const listDiv = document.getElementById('daySessionsList');
        listDiv.innerHTML = '';
        const sessions = DB.history.filter(s => s.date === dateStr);
        if (sessions.length === 0) { listDiv.innerHTML = '<div style="color:#b2bec3; font-style:italic;">Aucune séance ce jour-là.</div>'; return; }
        sessions.forEach(s => {
            const item = document.createElement('div');
            item.className = 'session-item-detail';
            item.innerHTML = `<span>${s.programName}</span> <small style="color:#636e72">Voir Historique pour détails</small>`;
            listDiv.appendChild(item);
        });
    }

    // --- DATA ---
    function exportData() {
        const dataStr = JSON.stringify(DB);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const exportFileDefaultName = 'gym_tracker_backup_' + new Date().toLocaleDateString().replace(/\//g, '-') + '.json';
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', exportFileDefaultName);
        linkElement.click();
    }
    function triggerImport() { document.getElementById('importFile').click(); }
    function importData(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.progs && data.history) {
                        if(confirm("Attention : Cela va remplacer toutes vos données actuelles. Continuer ?")) {
                            DB = data;
                            localStorage.setItem('gym_v8_progs', JSON.stringify(DB.progs));
                            localStorage.setItem('gym_v21_history', JSON.stringify(DB.history));
                            alert("Données restaurées !");
                            location.reload();
                        }
                    } else { alert("Fichier invalide."); }
                } catch(err) { alert("Erreur fichier."); }
            };
            reader.readAsText(input.files[0]);
        }
    }

    function initSortable() {
        const el = document.getElementById('builderListDisplay');
        new Sortable(el, { animation: 150, ghostClass: 'sortable-ghost', filter: '.delete-x', delay: 200, delayOnTouchOnly: true, onEnd: function(evt) { updateBuilderOrder(); resetBuilderForm(); } });
    }
    function updateBuilderOrder() {
        const newOrder = [];
        const items = document.querySelectorAll('#builderListDisplay .builder-item');
        items.forEach(item => {
            const dataItem = JSON.parse(item.getAttribute('data-json'));
            if(dataItem.type === 'solo') { newOrder.push(dataItem.data); } 
            else if (dataItem.type === 'superset') { newOrder.push(dataItem.dataA); newOrder.push(dataItem.dataB); }
        });
        tempBuilderList = newOrder;
        renderBuilder(); 
    }

    function getLastPerfRaw(exoName, setNum, progName) {
        const lastSession = DB.history.find(session => session.programName === progName && session.details && session.details.some(log => log.exo === exoName));
        if (!lastSession) return null;
        const log = lastSession.details.find(l => l.exo === exoName && l.serie === setNum);
        return log ? log.perf : null;
    }
    function getSplitPerf(exoName, setNum, progName) {
        const raw = getLastPerfRaw(exoName, setNum, progName);
        if (!raw) return null;
        let cleanRaw = raw.replace(/ \+ Dégressive: /g, " + ").replace(/Dégressive: /g, "+ ");
        const parts = cleanRaw.split(" + ");
        return { main: parts[0], drop: parts[1] || null };
    }

    function editBuilderItem(index) {
        currentEditingIndex = index;
        const item = tempBuilderList[index];
        document.getElementById('builderArea').scrollIntoView({behavior: 'smooth'});
        if (item.isSuperset && tempBuilderList[index+1] && tempBuilderList[index+1].isSuperset) {
            const itemB = tempBuilderList[index+1];
            activerModeSuperset();
            document.getElementById('buildExoName').value = item.name;
            document.getElementById('buildSeries').value = item.sets;
            document.getElementById('buildReps').value = item.reps;
            document.getElementById('buildExoNameB').value = itemB.name;
            document.getElementById('buildSeriesB').value = itemB.sets;
            document.getElementById('buildRepsB').value = itemB.reps;
            document.getElementById('btnAddSupersetConfirm').innerText = "Modifier le Superset";
        } else if (item.isSuperset && tempBuilderList[index-1] && tempBuilderList[index-1].isSuperset) {
            editBuilderItem(index - 1); return;
        } else {
            annulerModeSuperset();
            document.getElementById('buildExoName').value = item.name;
            document.getElementById('buildSeries').value = item.sets;
            document.getElementById('buildReps').value = item.reps;
            document.getElementById('btnAddNormal').innerText = "Modifier l'exercice";
        }
        renderBuilder(); document.getElementById('buildExoName').focus();
    }

    function ajouterExoAuBuilder() {
        const n = document.getElementById('buildExoName').value;
        let s = parseInt(document.getElementById('buildSeries').value);
        if(s < 1 || isNaN(s)) s = 1; const r = document.getElementById('buildReps').value;
        if(!n) return alert("Nom manquant");
        const newExo = {name:n, sets:s, reps:r, isSuperset: false};
        if (currentEditingIndex > -1) { tempBuilderList[currentEditingIndex] = newExo; } else { tempBuilderList.push(newExo); }
        resetBuilderForm(); renderBuilder(); document.getElementById('buildExoName').value = ''; document.getElementById('buildExoName').focus();
    }

    function validerSupersetBuilder() {
        const nA = document.getElementById('buildExoName').value; let sA = parseInt(document.getElementById('buildSeries').value); if(sA < 1 || isNaN(sA)) sA = 1; const rA = document.getElementById('buildReps').value;
        const nB = document.getElementById('buildExoNameB').value; let sB = parseInt(document.getElementById('buildSeriesB').value); if(sB < 1 || isNaN(sB)) sB = 1; const rB = document.getElementById('buildRepsB').value;
        if(!nA || !nB) return alert("Remplis les deux noms !");
        const exoA = {name:nA, sets:sA, reps:rA, isSuperset: true}; const exoB = {name:nB, sets:sB, reps:rB, isSuperset: true};
        if (currentEditingIndex > -1) { tempBuilderList[currentEditingIndex] = exoA; tempBuilderList[currentEditingIndex+1] = exoB; } else { tempBuilderList.push(exoA); tempBuilderList.push(exoB); }
        resetBuilderForm(); renderBuilder(); document.getElementById('buildExoName').value = ''; document.getElementById('buildExoNameB').value = ''; annulerModeSuperset(); document.getElementById('buildExoName').focus();
    }

    function resetBuilderForm() {
        currentEditingIndex = -1;
        document.getElementById('buildExoName').value = ''; document.getElementById('buildSeries').value = ''; document.getElementById('buildReps').value = ''; document.getElementById('buildExoNameB').value = '';
        document.getElementById('btnAddNormal').innerText = "Ajouter"; document.getElementById('btnAddSupersetConfirm').innerText = "Valider le Superset";
        annulerModeSuperset(); renderBuilder(); 
    }

    function renderBuilder() { 
        const listDiv = document.getElementById('builderListDisplay'); listDiv.innerHTML = ''; 
        for (let i = 0; i < tempBuilderList.length; i++) { 
            const item = tempBuilderList[i]; 
            let editingClass = ''; if (currentEditingIndex !== -1) { if (i === currentEditingIndex || (item.isSuperset && i === currentEditingIndex + 1)) { editingClass = 'editing-active'; } }
            if (item.isSuperset && tempBuilderList[i+1] && tempBuilderList[i+1].isSuperset) { 
                const nextItem = tempBuilderList[i+1]; const dataJson = JSON.stringify({ type: 'superset', dataA: item, dataB: nextItem });
                listDiv.innerHTML += `<div class="builder-item builder-item-superset ${editingClass}" data-json='${dataJson}'><span class="delete-x" onclick="tempBuilderList.splice(${i}, 2); resetBuilderForm(); renderBuilder()">✖</span><div class="builder-click-zone" onclick="editBuilderItem(${i})" title="Cliquer pour modifier"><div style="margin-bottom:12px;"> <span class="builder-exo-name">${item.name}</span> <span class="builder-exo-info">${item.sets} x ${item.reps} reps</span> </div><div> <span class="builder-exo-name">${nextItem.name}</span> <span class="builder-exo-info">${nextItem.sets} x ${nextItem.reps} reps</span> </div></div></div>`; i++; 
            } else { 
                const dataJson = JSON.stringify({ type: 'solo', data: item });
                listDiv.innerHTML += `<div class="builder-item builder-item-solo ${editingClass}" data-json='${dataJson}'><span class="delete-x" onclick="tempBuilderList.splice(${i}, 1); resetBuilderForm(); renderBuilder()">✖</span><div class="builder-click-zone" onclick="editBuilderItem(${i})" title="Cliquer pour modifier"><span class="builder-exo-name">${item.name}</span> <span class="builder-exo-info">${item.sets} x ${item.reps} reps</span></div></div>`; 
            } 
        } 
    }

    function startEditProgram(btn, e) {
        e.stopPropagation(); const name = btn.getAttribute('data-name'); resetBuilderForm(); 
        tempBuilderList = JSON.parse(JSON.stringify(DB.progs[name])); 
        document.getElementById('newProgName').value = name;
        document.getElementById('builderArea').classList.remove('hidden'); renderBuilder(); document.getElementById('builderArea').scrollIntoView({behavior: 'smooth'}); document.getElementById('btnSaveProg').innerText = "Mettre à jour la Séance"; 
    }

    function sauvegarderProgrammeFinal() { 
        const pendingName = document.getElementById('buildExoName').value;
        if(pendingName.trim() !== "") { alert("Attention : Tu as un exercice en cours de saisie ! Ajoute-le ou efface le champ avant de sauvegarder."); return; }
        const name = document.getElementById('newProgName').value; 
        if(name && tempBuilderList.length > 0) { DB.progs[name] = tempBuilderList; localStorage.setItem('gym_v8_progs', JSON.stringify(DB.progs)); resetBuilderForm(); tempBuilderList = []; document.getElementById('newProgName').value = ''; renderBuilder(); updateSelectMenu(); renderProgramList(); toggleBuilder(); } 
    }

    function deleteProg(name, e) { e.stopPropagation(); if(confirm("Supprimer ?")) { delete DB.progs[name]; localStorage.setItem('gym_v8_progs', JSON.stringify(DB.progs)); updateSelectMenu(); renderProgramList(); chargerInterface(); } }
    function updateSelectMenu() { const s = document.getElementById('selectProgram'); s.innerHTML = '<option value="" disabled selected>Choisir une Séance</option>'; Object.keys(DB.progs).forEach(k => s.innerHTML += `<option value="${k}">${k}</option>`); }
    function renderProgramList() { const div = document.getElementById('listeMesProgrammes'); div.innerHTML = ''; colorBag = [...allColors]; Object.keys(DB.progs).forEach(k => { let html = ` <div class="prog-item" onclick="toggleDetails('${k}')"> <span class="prog-title">${k}</span> <div class="prog-header-actions"><button class="btn-edit" data-name="${k}" onclick="startEditProgram(this, event)">Modifier</button><button class="btn-danger" onclick="deleteProg('${k.replace(/'/g, "\\'")}', event)">Supprimer</button></div> </div> <div id="details-${k}" class="prog-details-box">`; const exos = DB.progs[k]; for (let i = 0; i < exos.length; i++) { const e = exos[i]; if (e.isSuperset && exos[i+1] && exos[i+1].isSuperset) { const eNext = exos[i+1]; const duoColor = getNextColor(); html += `<div class="superset-wrapper" style="background: ${duoColor}20; border: 1px solid ${duoColor}50;">`; html += ` <div class="prog-line" style="border-left-color: ${duoColor}; border-bottom: none; padding-bottom: 5px;"> <span class="prog-line-name">${e.name}</span> <span class="prog-line-info">${e.sets} x ${e.reps} reps</span> </div>`; html += ` <div class="prog-line" style="border-left-color: ${duoColor}; padding-top: 5px;"> <span class="prog-line-name">${eNext.name}</span> <span class="prog-line-info">${eNext.sets} x ${eNext.reps} reps</span> </div>`; html += `</div>`; i++; } else { const soloColor = getNextColor(); html += `<div class="exo-wrapper" style="background: ${soloColor}20; border: 1px solid ${soloColor}50;"> <div class="prog-line" style="border-left-color: ${soloColor}"> <span class="prog-line-name">${e.name}</span> <span class="prog-line-info">${e.sets} x ${e.reps} reps</span> </div> </div>`; } } html += `</div>`; div.innerHTML += html; }); }
    function toggleDetails(id) { document.getElementById('details-'+id).classList.toggle('open'); }
    function toggleBuilder() { const area = document.getElementById('builderArea'); if (!area.classList.contains('hidden')) { resetBuilderForm(); document.getElementById('newProgName').value = ''; tempBuilderList = []; renderBuilder(); document.getElementById('btnSaveProg').innerText = "Sauvegarder la Séance"; } area.classList.toggle('hidden'); }
    
    function chargerInterface() { 
        const key = document.getElementById('selectProgram').value; const zone = document.getElementById('zoneTravail'); const btnZone = document.getElementById('zoneFinSeance'); zone.innerHTML = ''; btnZone.innerHTML = ''; currentSessionLogs = []; 
        if (!key) return; const exos = DB.progs[key]; colorBag = [...allColors]; 
        for(let i = 0; i < exos.length; i++) { 
            const exoA = exos[i]; const exoB = exos[i+1]; const color = getNextColor(); 
            if(exoA.isSuperset && exoB && exoB.isSuperset) { renderSuperset(zone, exoA, i, exoB, i+1, color, key); i++; } 
            else { renderNormal(zone, exoA, i, color, key); } 
        } 
        btnZone.innerHTML = `<button class="btn-terminate-session" onclick="terminerLaSeance('${key}')">Terminer la Séance</button>`; 
    }
    
    function createInputWithUnit(id, unit) { return `<div class="input-wrapper"><input type="number" id="${id}" placeholder="" min="0" oninput="this.value = Math.abs(this.value)"><span class="unit-label">${unit}</span></div>`; }
    function createDropInput(className, unit) { return `<div class="input-wrapper"><input type="number" class="${className}" placeholder="" min="0" oninput="this.value = Math.abs(this.value)"><span class="unit-label">${unit}</span></div>`; }
    
    function renderNormal(container, exo, idx, color, progName) { 
        let html = `<div class="card" style="--card-color: ${color}; border-left-color: ${color}; animation-delay: ${idx * 0.1}s"><div class="card-header"><div class="header-top"><span class="exo-title">${exo.name}</span><span class="exo-badge">Fourchette de reps : ${exo.reps}</span></div></div><div id="sets_${idx}">`; 
        for(let s=1; s<=exo.sets; s++) { 
            const data = getSplitPerf(exo.name, s, progName);
            const mainPerfHTML = (data && data.main) ? `<span class="last-perf">Précédent : ${data.main}</span>` : '';
            const safeExoName = exo.name.replace(/'/g, "\\'"); const safeProgName = progName.replace(/'/g, "\\'");
            html += `<div class="serie-container" id="container_${idx}_${s}"><div class="input-row"><div class="set-col"><div class="set-num">#${s}</div><button class="btn-mini-add" onclick="ajouterDegressive('${idx}_${s}', '${safeExoName}', '${safeProgName}', ${s})">+</button></div>${createInputWithUnit(`p_${idx}_${s}`, 'kg')}${createInputWithUnit(`r_${idx}_${s}`, 'reps')}</div>${mainPerfHTML}</div>`; 
        } 
        html += `</div><button class="btn-finish-exo" id="btn_finish_${idx}" onclick="validerExerciceNormal('${exo.name}', ${idx}, ${exo.sets}, this, '${color}')">Exercice Fini</button></div>`; 
        container.innerHTML += html; 
    }
    
    // --- CORRECTION V94 : LOGIQUE SUPERSET (Cases vides si séries inégales) ---
    function renderSuperset(container, exoA, idxA, exoB, idxB, color, progName) { 
        const max = Math.max(exoA.sets, exoB.sets); 
        const safeProgName = progName.replace(/'/g, "\\'"); 
        const safeExoNameA = exoA.name.replace(/'/g, "\\'"); 
        const safeExoNameB = exoB.name.replace(/'/g, "\\'");
        
        let html = `<div class="card superset-container" style="--card-color: ${color}; border-left-color: ${color}; animation-delay: ${idxA * 0.1}s"><span class="superset-label" style="background:${color}">Superset</span>`;
        
        // Header A
        html += `<div class="card-header" style="border:none; padding-bottom:5px; margin-bottom:5px;"><div class="header-top"><span class="exo-title">A. ${exoA.name}</span> <span class="exo-badge">Fourchette de reps : ${exoA.reps}</span></div></div>`;
        // Header B
        html += `<div class="card-header"><div class="header-top"><span class="exo-title">B. ${exoB.name}</span> <span class="exo-badge">Fourchette de reps : ${exoB.reps}</span></div></div>`;
        
        html += `<div id="sets_super_${idxA}">`; 
        for(let s=1; s<=max; s++) { 
            html += `<div class="set-block">`;
            
            // LIGNE EXO A (Si la série existe pour A)
            if (s <= exoA.sets) {
                const dataA = getSplitPerf(exoA.name, s, progName); 
                const mainPerfHTMLA = (dataA && dataA.main) ? `<span class="last-perf">Précédent : ${dataA.main}</span>` : '';
                html += `<div class="serie-container" id="container_${idxA}_${s}"><div class="input-row"><div class="set-col"><div class="set-num">A</div><button class="btn-mini-add" onclick="ajouterDegressive('${idxA}_${s}', '${safeExoNameA}', '${safeProgName}', ${s})">+</button></div>${createInputWithUnit(`p_${idxA}_${s}`, 'kg')}${createInputWithUnit(`r_${idxA}_${s}`, 'reps')}</div>${mainPerfHTMLA}</div>`;
            } else {
                // Placeholder invisible pour garder l'alignement ou vide
                html += `<div class="serie-container" style="opacity:0.3; pointer-events:none;"><div class="input-row"><div class="set-col"><div class="set-num">-</div></div><div class="input-wrapper" style="background:transparent; border:1px dashed #eee;"></div></div></div>`;
            }

            // LIGNE EXO B (Si la série existe pour B)
            if (s <= exoB.sets) {
                const dataB = getSplitPerf(exoB.name, s, progName); 
                const mainPerfHTMLB = (dataB && dataB.main) ? `<span class="last-perf">Précédent : ${dataB.main}</span>` : '';
                html += `<div class="serie-container" id="container_${idxB}_${s}"><div class="input-row"><div class="set-col"><div class="set-num">B</div><button class="btn-mini-add" onclick="ajouterDegressive('${idxB}_${s}', '${safeExoNameB}', '${safeProgName}', ${s})">+</button></div>${createInputWithUnit(`p_${idxB}_${s}`, 'kg')}${createInputWithUnit(`r_${idxB}_${s}`, 'reps')}</div>${mainPerfHTMLB}</div>`;
            } else {
                html += `<div class="serie-container" style="opacity:0.3; pointer-events:none;"><div class="input-row"><div class="set-col"><div class="set-num">-</div></div><div class="input-wrapper" style="background:transparent; border:1px dashed #eee;"></div></div></div>`;
            }
            
            html += `</div>`; // Fin set-block
        } 
        html += `</div><button class="btn-finish-exo" id="btn_finish_${idxA}" onclick="validerSuperset('${exoA.name}', ${idxA}, '${exoB.name}', ${idxB}, ${max}, this, '${color}')">Exercices Finis</button></div>`; 
        container.innerHTML += html; 
    }
    
    function ajouterDegressive(baseId, exoName, progName, setNum) { 
        const container = document.getElementById('container_' + baseId); 
        const div = document.createElement('div'); div.className = 'input-row drop-row'; 
        const data = getSplitPerf(exoName, setNum, progName);
        const dropHint = (data && data.drop) ? `<span class="last-perf" style="margin-left:45px;">Précédent : ${data.drop}</span>` : '';
        div.innerHTML = `<div class="set-col"><div class="drop-icon" onclick="this.closest('.drop-row').remove()" title="Supprimer">↳</div></div>${createDropInput('drop-weight', 'kg')}${createDropInput('drop-reps', 'reps')}`; 
        div.style.flexWrap = "wrap";
        if(dropHint) div.innerHTML += `<div style="width:100%;">${dropHint}</div>`;
        container.appendChild(div); 
    }

    function getDropsString(containerId) { const container = document.getElementById(containerId); let drops = []; container.querySelectorAll('.drop-row').forEach(row => { const w = row.querySelector('.drop-weight').value; const r = row.querySelector('.drop-reps').value; if(w && r) drops.push(`${w} kg x ${r} reps`); }); if(drops.length > 0) return " + " + drops.join(' + '); return ""; }
    
    function validerExerciceNormal(nomExo, idx, totalSets, btn, color) { if (btn.classList.contains('validated')) { btn.classList.remove('validated'); btn.innerText = "Exercice Fini"; btn.style.backgroundColor = "var(--btn-default-bg)"; btn.style.color = "var(--btn-default-text)"; btn.style.boxShadow = "none"; for(let s=1; s<=totalSets; s++) { document.getElementById(`p_${idx}_${s}`).disabled = false; document.getElementById(`r_${idx}_${s}`).disabled = false; const container = document.getElementById(`container_${idx}_${s}`); container.querySelectorAll('input').forEach(i => i.disabled = false); if(container.querySelector('.btn-mini-add')) container.querySelector('.btn-mini-add').style.display = 'flex'; container.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'block'); } currentSessionLogs = currentSessionLogs.filter(log => log.exo !== nomExo); return; } let savedCount = 0; let tempLogs = []; for(let s=1; s<=totalSets; s++) { const p = document.getElementById(`p_${idx}_${s}`).value; const r = document.getElementById(`r_${idx}_${s}`).value; if(p && r) { let dropText = getDropsString(`container_${idx}_${s}`); tempLogs.push({ exo: nomExo, perf: `${p} kg x ${r} reps${dropText}`, serie: s }); savedCount++; } } if(savedCount > 0) { currentSessionLogs.push(...tempLogs); btn.classList.add('validated'); btn.innerText = "Validé"; btn.style.backgroundColor = color; btn.style.color = "#fff"; for(let s=1; s<=totalSets; s++) { document.getElementById(`p_${idx}_${s}`).disabled = true; document.getElementById(`r_${idx}_${s}`).disabled = true; const container = document.getElementById(`container_${idx}_${s}`); container.querySelectorAll('input').forEach(i => i.disabled = true); if(container.querySelector('.btn-mini-add')) container.querySelector('.btn-mini-add').style.display = 'none'; container.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'none'); } } else { alert("Remplis au moins une série !"); } }
    
    function validerSuperset(nomA, idxA, nomB, idxB, totalSets, btn, color) { 
        if (btn.classList.contains('validated')) { 
            btn.classList.remove('validated'); btn.innerText = "Exercices Finis"; btn.style.backgroundColor = "var(--btn-default-bg)"; btn.style.color = "var(--btn-default-text)"; btn.style.boxShadow = "none"; 
            for(let s=1; s<=totalSets; s++) { 
                if(document.getElementById(`p_${idxA}_${s}`)) {
                     document.getElementById(`p_${idxA}_${s}`).disabled = false; document.getElementById(`r_${idxA}_${s}`).disabled = false; 
                     const cA = document.getElementById(`container_${idxA}_${s}`); cA.querySelectorAll('input').forEach(i => i.disabled = false); if(cA.querySelector('.btn-mini-add')) cA.querySelector('.btn-mini-add').style.display = 'flex'; cA.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'block'); 
                }
                if(document.getElementById(`p_${idxB}_${s}`)) {
                     document.getElementById(`p_${idxB}_${s}`).disabled = false; document.getElementById(`r_${idxB}_${s}`).disabled = false; 
                     const cB = document.getElementById(`container_${idxB}_${s}`); cB.querySelectorAll('input').forEach(i => i.disabled = false); if(cB.querySelector('.btn-mini-add')) cB.querySelector('.btn-mini-add').style.display = 'flex'; cB.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'block'); 
                }
            } 
            currentSessionLogs = currentSessionLogs.filter(log => log.exo !== nomA && log.exo !== nomB); return; 
        } 
        
        let savedCount = 0; let tempLogs = []; 
        for(let s=1; s<=totalSets; s++) { 
            if(document.getElementById(`p_${idxA}_${s}`)) {
                const pA = document.getElementById(`p_${idxA}_${s}`).value; const rA = document.getElementById(`r_${idxA}_${s}`).value; 
                if(pA && rA) { let dropTextA = getDropsString(`container_${idxA}_${s}`); tempLogs.push({ exo: nomA, perf: `${pA} kg x ${rA} reps${dropTextA}`, serie: s }); savedCount++; } 
            }
            if(document.getElementById(`p_${idxB}_${s}`)) {
                const pB = document.getElementById(`p_${idxB}_${s}`).value; const rB = document.getElementById(`r_${idxB}_${s}`).value; 
                if(pB && rB) { let dropTextB = getDropsString(`container_${idxB}_${s}`); tempLogs.push({ exo: nomB, perf: `${pB} kg x ${rB} reps${dropTextB}`, serie: s }); savedCount++; } 
            }
        } 
        
        if(savedCount > 0) { 
            currentSessionLogs.push(...tempLogs); btn.classList.add('validated'); btn.innerText = "Validé"; btn.style.backgroundColor = color; btn.style.color = "#fff"; 
            for(let s=1; s<=totalSets; s++) { 
                if(document.getElementById(`p_${idxA}_${s}`)) { document.getElementById(`p_${idxA}_${s}`).disabled = true; document.getElementById(`r_${idxA}_${s}`).disabled = true; const cA = document.getElementById(`container_${idxA}_${s}`); cA.querySelectorAll('input').forEach(i => i.disabled = true); if(cA.querySelector('.btn-mini-add')) cA.querySelector('.btn-mini-add').style.display = 'none'; cA.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'none'); }
                if(document.getElementById(`p_${idxB}_${s}`)) { document.getElementById(`p_${idxB}_${s}`).disabled = true; document.getElementById(`r_${idxB}_${s}`).disabled = true; const cB = document.getElementById(`container_${idxB}_${s}`); cB.querySelectorAll('input').forEach(i => i.disabled = true); if(cB.querySelector('.btn-mini-add')) cB.querySelector('.btn-mini-add').style.display = 'none'; cB.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'none'); }
            } 
        } else { alert("Remplis au moins une série !"); } 
    }
    
    function terminerLaSeance(progName) { if(currentSessionLogs.length === 0) return alert("Tu n'as rien validé !"); if(confirm("Confirmer la fin de la séance ?")) { const sessionObject = { id: Date.now(), date: new Date().toLocaleDateString(), programName: progName, details: currentSessionLogs }; DB.history.unshift(sessionObject); localStorage.setItem('gym_v21_history', JSON.stringify(DB.history)); currentSessionLogs = []; alert("Séance sauvegardée !"); document.getElementById('selectProgram').value = ""; document.getElementById('zoneTravail').innerHTML = ""; document.getElementById('zoneFinSeance').innerHTML = ""; historyState.view = 'categories'; historyState.selected = null; renderHistory(); } }
    
    function renderHistory() { 
        const container = document.getElementById('listeHistorique'); 
        const titleEl = document.getElementById('histMainTitle'); 
        const btnEl = document.getElementById('histActionBtn'); 
        container.innerHTML = ''; 
        if(DB.history.length === 0) { 
            titleEl.innerText = "Types de Séances"; 
            btnEl.innerText = "Effacer toutes les Séances"; 
            btnEl.onclick = resetHistoryOnly;
            container.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px">Aucune séance enregistrée.</p>'; 
            historyState.view = 'categories';
            historyState.selected = null;
            return; 
        } 
        if (historyState.view === 'categories') { 
            titleEl.innerText = "Types de Séances"; 
            btnEl.innerText = "Effacer toutes les Séances"; 
            btnEl.onclick = resetHistoryOnly; 
            const groups = {}; DB.history.forEach(s => { if(!groups[s.programName]) groups[s.programName] = 0; groups[s.programName]++; }); 
            Object.keys(groups).forEach(name => { 
                const count = groups[name]; 
                const btn = document.createElement('div'); btn.className = 'hist-category-btn'; 
                btn.innerHTML = `<span class="hist-cat-title">${name}</span> <span class="hist-count">${count}</span>`; 
                btn.onclick = () => { historyState.view = 'details'; historyState.selected = name; renderHistory(); }; 
                container.appendChild(btn); 
            }); 
        } else { 
            titleEl.innerText = "SÉANCES " + historyState.selected; 
            btnEl.innerText = "Effacer les Séances " + historyState.selected; 
            btnEl.onclick = () => deleteCategoryHistory(historyState.selected); 
            const backBtn = document.createElement('div'); backBtn.className = 'btn-back-hist'; 
            backBtn.innerText = 'Retour aux types de Séances'; 
            backBtn.onclick = () => { historyState.view = 'categories'; historyState.selected = null; renderHistory(); }; 
            container.appendChild(backBtn); 
            const filtered = DB.history.filter(s => s.programName === historyState.selected); 
            filtered.forEach(session => { 
                const wrapper = document.createElement('div'); wrapper.className = 'hist-session'; 
                const header = document.createElement('div'); header.className = 'hist-header'; header.innerHTML = `<span class="hist-date-large">${session.date}</span>`; 
                const body = document.createElement('div'); body.className = 'hist-body'; 
                if(session.details && session.details.length > 0) { session.details.forEach(log => { 
                    let cleanPerf = log.perf.replace(/ \+ Dégressive: /g, " + ").replace(/Dégressive: /g, "+ ");
                    body.innerHTML += `<div class="hist-exo-line"><span class="hist-exo-name">${log.exo} <small style="color:#b2bec3;">(#${log.serie})</small></span><span class="hist-exo-perf">${cleanPerf}</span></div>`; 
                }); } 
                else { body.innerHTML = '<div style="padding:10px; color:#999">Pas de détails.</div>'; } 
                header.onclick = () => { body.classList.toggle('open'); }; 
                wrapper.appendChild(header); wrapper.appendChild(body); container.appendChild(wrapper); 
            }); 
        } 
    }

    function resetHistoryOnly() { if(confirm("Effacer tout l'historique ?")) { DB.history = []; localStorage.setItem('gym_v21_history', JSON.stringify([])); historyState.view = 'categories'; renderHistory(); } }
    function deleteCategoryHistory(catName) { if(confirm("Effacer tout l'historique pour " + catName + " ?")) { DB.history = DB.history.filter(s => s.programName !== catName); localStorage.setItem('gym_v21_history', JSON.stringify(DB.history)); historyState.view = 'categories'; historyState.selected = null; renderHistory(); } }
    function activerModeSuperset() { document.getElementById('blockExoB').classList.remove('hidden'); document.getElementById('btnGroupNormal').classList.add('hidden'); document.getElementById('btnGroupSuperset').classList.remove('hidden'); document.getElementById('labelExoA').classList.remove('hidden'); }
    function annulerModeSuperset() { document.getElementById('blockExoB').classList.add('hidden'); document.getElementById('btnGroupNormal').classList.remove('hidden'); document.getElementById('btnGroupSuperset').classList.add('hidden'); document.getElementById('labelExoA').classList.add('hidden'); document.getElementById('buildExoNameB').value = ''; }
</script>

</body>
</html>
