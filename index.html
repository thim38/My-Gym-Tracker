<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Tracker V86 Compact Perf</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- VARIABLES --- */
        :root { --bg-body: #f8f9fa; --bg-card: #ffffff; --text-main: #2d3436; --text-gray: #636e72; --input-bg: #f1f3f5; --shadow: 0 4px 20px rgba(0,0,0,0.04); --btn-default-bg: #e9ecef; --btn-default-text: #495057; --brand: #2d3436; --highlight: #ffeaa7; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 15px; padding-bottom: 100px; -webkit-font-smoothing: antialiased; overscroll-behavior-y: contain; }
        h1 { text-align: center; margin-bottom: 30px; font-weight: 900; text-transform: uppercase; font-size: 1.4rem; }
        .container { max-width: 600px; margin: 0 auto; }
        .hidden { display: none !important; }
        
        select { width: 100%; padding: 16px; border-radius: 16px; border: 1px solid transparent; background: #fff; font-size: 1rem; margin-bottom: 25px; font-weight: 700; outline: none; text-align: center; text-align-last: center; box-shadow: var(--shadow); }
        .input-wrapper { position: relative; flex: 1; min-width: 0; }
        input { width: 100%; padding: 14px; padding-right: 35px; background: var(--input-bg); border: 2px solid transparent; border-radius: 16px; font-weight: 600; font-size: 16px; color: var(--text-main); box-sizing: border-box; transition: 0.3s; }
        input:focus { outline: none; background: #fff; border-color: #dfe6e9; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .unit-label { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; font-weight: 700; color: #b2bec3; pointer-events: none; }

        button { border: none; cursor: pointer; font-weight: 700; border-radius: 16px; transition: 0.2s; position: relative; overflow: hidden; }
        button:active { transform: scale(0.96); opacity: 0.9; }
        .btn-primary { width: 100%; padding: 15px; background: var(--text-main); color: #fff; font-size: 1rem; margin-top: 15px; }
        .btn-add { width: 100%; padding: 12px; background: #fff; border: 2px solid #f1f3f5; color: var(--text-main); margin-top: 5px; font-size: 0.9rem;}
        .btn-add:hover { border-color: #dee2e6; background: #f8f9fa; }
        .btn-add-superset { background: #ffeaa7; color: #d35400; padding: 12px; width: 100%; margin-top:10px; font-size: 0.9rem;}
        .btn-danger { background: #ff6b6b; color: white; padding: 8px 16px; font-size: 0.8rem; border-radius: 14px; }
        .btn-cancel { background: transparent; color: #636e72; padding: 10px; width: 100%; margin-top: 5px; font-size: 0.8rem; }
        .btn-edit { background: #fff; color: #2d3436; border: 1px solid #dfe6e9; padding: 8px 16px; font-size: 0.8rem; border-radius: 14px; margin-right:8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .btn-finish-exo { width: 100%; padding: 16px; background-color: var(--btn-default-bg); color: var(--btn-default-text); font-size: 0.95rem; margin-top: 15px; transition: background-color 0.3s; }
        .btn-finish-exo.validated { color: #fff !important; cursor: default; transform: none; box-shadow: none; }
        
        .btn-terminate-session { width: 100%; padding: 18px; background-color: var(--brand); color: #fff; font-size: 1.1rem; margin-top: 40px; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; }

        .card { background: var(--bg-card); border-radius: 24px; box-shadow: var(--shadow); margin-bottom: 25px; padding: 20px; border-left: 10px solid #333; animation: fadeInUp 0.5s ease; }
        .card-header { display: flex; flex-direction: column; gap:8px; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #f1f1f1; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .exo-title { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
        .exo-badge { background: var(--input-bg); color: var(--text-gray); font-size: 0.75rem; font-weight: 600; padding: 6px 12px; border-radius: 12px; }
        .card.superset-container { border: 1px solid #eee; border-left-width: 10px; border-left-style: solid; }
        .superset-label { font-size: 0.7rem; font-weight: 900; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 15px; display: block; text-align: center; color: #fff; padding: 5px 0; border-radius: 20px; width: 100px; margin: 0 auto 20px auto; }
        .set-block { border-bottom: 1px dashed #eee; padding-bottom: 15px; margin-bottom: 15px; }
        .set-block:last-child { border-bottom: none; margin-bottom: 0; }
        
        .serie-container { margin-bottom: 12px; }
        .input-row { display: flex; align-items: center; gap: 10px; width: 100%; }
        .set-col { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 35px; flex-shrink: 0; gap: 4px; }
        .set-num { font-weight: 700; color: #ced4da; font-size: 0.85rem; }
        .btn-mini-add { width: 20px; height: 20px; border-radius: 50%; background: #e9ecef; color: #636e72; border: none; font-size: 16px; line-height: 1; cursor: pointer; display: flex; align-items: center; justify-content: center; padding: 0; }
        
        .drop-row { margin-top: 8px; animation: fadeInUp 0.3s ease; }
        .drop-icon { font-size: 1.2rem; font-weight: 900; cursor: pointer; color: var(--card-color); }

        .last-perf {
            font-size: 0.75rem;
            color: #b2bec3;
            font-weight: 600;
            margin-top: 4px;
            margin-left: 45px; 
            display: block;
            width: 100%;
        }

        .builder-btn { width: 100%; padding: 20px; background: #fff; color: var(--text-main); box-shadow: var(--shadow); margin-bottom: 25px; border-radius: 24px; font-size:1rem; border: 1px solid transparent; }
        #builderArea { background: #fff; padding: 25px; border-radius: 24px; margin-bottom: 20px; box-shadow: var(--shadow); }
        .builder-block { background:#f8f9fa; padding:15px; border-radius: 16px; margin-bottom:10px; border:1px solid #eee; }
        .builder-row { display: flex; gap: 15px; margin-bottom: 10px; }
        .builder-label { font-size: 0.8rem; font-weight: 700; color: #b2bec3; margin-bottom: 5px; display: block; text-transform: uppercase; }
        
        /* ITEM DU BUILDER */
        .builder-item { 
            background: #f8f9fa; border: 1px solid #eee; border-radius: 16px; 
            margin-bottom: 10px; padding: 15px 40px 15px 15px; position: relative; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: grab; transition: 0.2s; touch-action: manipulation; 
        }
        .builder-item:active { cursor: grabbing; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .builder-item.editing-active { border: 2px solid #fdcb6e; background-color: #fffbf0; transform: scale(1.02); }

        .builder-click-zone { cursor: pointer; width: 100%; height: 100%; }
        .builder-click-zone:active { opacity: 0.6; }
        .delete-x { position: absolute; top: 12px; right: 15px; color: #ff6b6b; font-weight: 900; font-size: 1.1rem; cursor: pointer; z-index: 10; padding: 5px; }
        .builder-exo-name { display: block; font-weight: 800; font-size: 1rem; color: #2d3436; margin-bottom: 4px; }
        .builder-exo-info { display: block; font-size: 0.85rem; font-weight: 600; color: #636e72; }

        .prog-item { background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 24px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); cursor: pointer; }
        .prog-title { font-weight: 800; font-size: 1.1rem; color: #2d3436; }
        .prog-header-actions { display: flex; gap: 5px; }
        .prog-details-box { padding: 20px; background: #fff; margin-bottom: 20px; border-radius: 24px; box-shadow: var(--shadow); display: none; }
        .prog-details-box.open { display: block; animation: fadeInUp 0.3s ease-out; }
        .exo-wrapper, .superset-wrapper { border-radius: 16px; overflow: hidden; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .prog-line { display: flex; justify-content: space-between; align-items: center; padding: 16px 15px; border-left-width: 6px; border-left-style: solid; background: transparent; }
        .prog-line-name { font-weight: 700; color: #2d3436; font-size: 0.95rem; }
        .prog-line-info { color: #636e72; font-size: 0.85rem; font-weight: 600; }

        .hist-category-btn { background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 24px; box-shadow: var(--shadow); cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s; }
        .hist-cat-title { font-weight: 800; font-size: 1.1rem; color: var(--text-main); }
        .hist-count { background: var(--input-bg); color: #636e72; padding: 5px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; }
        .btn-back-hist { display: inline-block; margin-bottom: 15px; font-weight: 700; color: var(--text-gray); background: var(--input-bg); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.85rem; }
        .hist-session { background: #fff; border-radius: 24px; margin-bottom: 15px; box-shadow: var(--shadow); overflow: hidden; }
        .hist-header { padding: 20px; cursor: pointer; display: flex; align-items: center; background: #fff; }
        .hist-date-large { font-size: 1.1rem; font-weight: 800; color: var(--text-main); }
        .hist-body { display: none; padding: 0 20px 20px; border-top: 1px solid #f1f3f5; }
        .hist-body.open { display: block; }
        .hist-exo-line { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #eee; font-size: 0.9rem; }
        .hist-exo-name { font-weight: 700; color: #2d3436; }
        .hist-exo-perf { color: #636e72; text-align: right; }

        .nav-bar { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: #fff; padding: 15px; border-radius: 30px; display: flex; justify-content: space-around; box-shadow: 0 10px 40px rgba(0,0,0,0.08); z-index: 999; }
        .nav-item { background: transparent; color: #adb5bd; font-size: 0.9rem; font-weight: 700; }
        .nav-item.active { color: var(--text-main); }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <h1 id="mainTitle">Ma Séance</h1>

    <div id="view-seance">
        <select id="selectProgram" onchange="chargerInterface()">
            <option value="" disabled selected>Choisir une Séance</option>
        </select>
        <div id="zoneTravail"></div>
        <div id="zoneFinSeance"></div>
    </div>

    <div id="view-progs" class="hidden">
        <button class="builder-btn" onclick="toggleBuilder()">Créer une Séance</button>
        
        <div id="builderArea" class="hidden">
            <h3 style="margin-top:0">Nouvelle Séance</h3>
            <input type="text" id="newProgName" placeholder="Nom de la séance" style="margin-bottom:15px;">
            
            <div class="builder-block">
                <span id="labelExoA" class="builder-label hidden">Exercice A (Principal)</span>
                <input type="text" id="buildExoName" placeholder="Nom de l'exercice" style="margin-bottom:10px;">
                <div class="builder-row">
                    <input type="number" id="buildSeries" placeholder="Séries" min="1">
                    <input type="text" id="buildReps" placeholder="Reps (ex: 10-12)">
                </div>
            </div>

            <div id="blockExoB" class="builder-block hidden">
                <span class="builder-label">Exercice B (Superset)</span>
                <input type="text" id="buildExoNameB" placeholder="Nom du 2ème exercice" style="margin-bottom:10px;">
                <div class="builder-row">
                    <input type="number" id="buildSeriesB" placeholder="Séries" min="1">
                    <input type="text" id="buildRepsB" placeholder="Reps (ex: 10-12)">
                </div>
            </div>

            <div id="builderButtons">
                <div id="btnGroupNormal">
                    <button id="btnAddNormal" class="btn-add" onclick="ajouterExoAuBuilder()">Ajouter</button>
                    <button id="btnAddSupersetSwitch" class="btn-add-superset" onclick="activerModeSuperset()">Ajouter un Superset</button>
                </div>
                <div id="btnGroupSuperset" class="hidden">
                    <button id="btnAddSupersetConfirm" class="btn-add-superset" style="background:#2d3436; color:#fff;" onclick="validerSupersetBuilder()">Valider le Superset</button>
                    <button class="btn-cancel" onclick="annulerModeSuperset()">Annuler le Superset</button>
                </div>
            </div>
            
            <div id="builderListDisplay" style="margin-bottom:15px; margin-top:15px;"></div>
            
            <button id="btnSaveProg" class="btn-primary" onclick="sauvegarderProgrammeFinal()">Sauvegarder la Séance</button>
        </div>

        <div id="listeMesProgrammes"></div>
    </div>

    <div id="view-history" class="hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:20px; align-items:center;">
            <h3 id="histMainTitle" style="margin:0; text-transform:uppercase;">Types de Séances</h3>
            <button id="histActionBtn" class="btn-danger" onclick="resetHistoryOnly()">Effacer toutes les Séances</button>
        </div>
        <div id="listeHistorique"></div>
    </div>
</div>

<nav class="nav-bar">
    <button class="nav-item active" onclick="switchTab('seance', this)">Séance</button>
    <button class="nav-item" onclick="switchTab('progs', this)">Programme</button>
    <button class="nav-item" onclick="switchTab('history', this)">Historique</button>
</nav>

<script>
    let DB = {
        progs: JSON.parse(localStorage.getItem('gym_v8_progs')) || {},
        history: JSON.parse(localStorage.getItem('gym_v21_history')) || []
    };
    
    let currentSessionLogs = [];
    let tempBuilderList = [];
    let currentEditingIndex = -1; 
    
    const allColors = ['#FFB7B2', '#FFDAC1', '#E2F0CB', '#B5EAD7', '#C7CEEA', '#E0BBE4', '#FF9AA2', '#957DAD'];
    let colorBag = [];
    let historyState = { view: 'categories', selected: null }; 

    function getNextColor() {
        if (colorBag.length === 0) colorBag = [...allColors];
        const randomIndex = Math.floor(Math.random() * colorBag.length);
        const selected = colorBag[randomIndex];
        colorBag.splice(randomIndex, 1);
        return selected;
    }

    document.addEventListener('DOMContentLoaded', () => {
        updateSelectMenu();
        renderProgramList();
        renderHistory();
        initSortable();
    });

    // --- SORTABLE JS ---
    function initSortable() {
        const el = document.getElementById('builderListDisplay');
        new Sortable(el, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            filter: '.delete-x',
            delay: 200, delayOnTouchOnly: true, 
            onEnd: function(evt) { 
                updateBuilderOrder();
                resetBuilderForm();
            }
        });
    }

    function updateBuilderOrder() {
        const newOrder = [];
        const items = document.querySelectorAll('#builderListDisplay .builder-item');
        items.forEach(item => {
            const dataItem = JSON.parse(item.getAttribute('data-json'));
            if(dataItem.type === 'solo') { newOrder.push(dataItem.data); } 
            else if (dataItem.type === 'superset') { newOrder.push(dataItem.dataA); newOrder.push(dataItem.dataB); }
        });
        tempBuilderList = newOrder;
        renderBuilder(); 
    }

    // --- FONCTION RECUPERATION PERF (V84 Contextuelle) ---
    function getLastPerf(exoName, setNum, progName) {
        const lastSession = DB.history.find(session => 
            session.programName === progName && 
            session.details && session.details.some(log => log.exo === exoName)
        );
        if (!lastSession) return null;
        const log = lastSession.details.find(l => l.exo === exoName && l.serie === setNum);
        return log ? log.perf : null;
    }

    // --- LOGIQUE EDITION ---
    function editBuilderItem(index) {
        currentEditingIndex = index;
        const item = tempBuilderList[index];
        document.getElementById('builderArea').scrollIntoView({behavior: 'smooth'});
        if (item.isSuperset && tempBuilderList[index+1] && tempBuilderList[index+1].isSuperset) {
            const itemB = tempBuilderList[index+1];
            activerModeSuperset();
            document.getElementById('buildExoName').value = item.name;
            document.getElementById('buildSeries').value = item.sets;
            document.getElementById('buildReps').value = item.reps;
            document.getElementById('buildExoNameB').value = itemB.name;
            document.getElementById('buildSeriesB').value = itemB.sets;
            document.getElementById('buildRepsB').value = itemB.reps;
            document.getElementById('btnAddSupersetConfirm').innerText = "Modifier le Superset";
        } else if (item.isSuperset && tempBuilderList[index-1] && tempBuilderList[index-1].isSuperset) {
            editBuilderItem(index - 1); return;
        } else {
            annulerModeSuperset();
            document.getElementById('buildExoName').value = item.name;
            document.getElementById('buildSeries').value = item.sets;
            document.getElementById('buildReps').value = item.reps;
            document.getElementById('btnAddNormal').innerText = "Modifier l'exercice";
        }
        renderBuilder(); document.getElementById('buildExoName').focus();
    }

    function ajouterExoAuBuilder() {
        const n = document.getElementById('buildExoName').value;
        let s = parseInt(document.getElementById('buildSeries').value);
        if(s < 1 || isNaN(s)) s = 1; 
        const r = document.getElementById('buildReps').value;
        if(!n) return alert("Nom manquant");
        const newExo = {name:n, sets:s, reps:r, isSuperset: false};
        if (currentEditingIndex > -1) { tempBuilderList[currentEditingIndex] = newExo; } else { tempBuilderList.push(newExo); }
        resetBuilderForm(); renderBuilder(); document.getElementById('buildExoName').value = ''; document.getElementById('buildExoName').focus();
    }

    function validerSupersetBuilder() {
        const nA = document.getElementById('buildExoName').value;
        let sA = parseInt(document.getElementById('buildSeries').value);
        if(sA < 1 || isNaN(sA)) sA = 1;
        const rA = document.getElementById('buildReps').value;
        const nB = document.getElementById('buildExoNameB').value;
        let sB = parseInt(document.getElementById('buildSeriesB').value);
        if(sB < 1 || isNaN(sB)) sB = 1;
        const rB = document.getElementById('buildRepsB').value;
        if(!nA || !nB) return alert("Remplis les deux noms !");
        const exoA = {name:nA, sets:sA, reps:rA, isSuperset: true};
        const exoB = {name:nB, sets:sB, reps:rB, isSuperset: true};
        if (currentEditingIndex > -1) { tempBuilderList[currentEditingIndex] = exoA; tempBuilderList[currentEditingIndex+1] = exoB; } else { tempBuilderList.push(exoA); tempBuilderList.push(exoB); }
        resetBuilderForm(); renderBuilder(); document.getElementById('buildExoName').value = ''; document.getElementById('buildExoNameB').value = ''; annulerModeSuperset(); document.getElementById('buildExoName').focus();
    }

    function resetBuilderForm() {
        currentEditingIndex = -1;
        document.getElementById('buildExoName').value = ''; document.getElementById('buildSeries').value = ''; document.getElementById('buildReps').value = ''; document.getElementById('buildExoNameB').value = '';
        document.getElementById('btnAddNormal').innerText = "Ajouter"; document.getElementById('btnAddSupersetConfirm').innerText = "Valider le Superset";
        annulerModeSuperset(); renderBuilder(); 
    }

    function renderBuilder() { 
        const listDiv = document.getElementById('builderListDisplay'); listDiv.innerHTML = ''; 
        for (let i = 0; i < tempBuilderList.length; i++) { 
            const item = tempBuilderList[i]; 
            let editingClass = '';
            if (currentEditingIndex !== -1) { if (i === currentEditingIndex || (item.isSuperset && i === currentEditingIndex + 1)) { editingClass = 'editing-active'; } }
            if (item.isSuperset && tempBuilderList[i+1] && tempBuilderList[i+1].isSuperset) { 
                const nextItem = tempBuilderList[i+1]; const dataJson = JSON.stringify({ type: 'superset', dataA: item, dataB: nextItem });
                listDiv.innerHTML += `<div class="builder-item builder-item-superset ${editingClass}" data-json='${dataJson}'><span class="delete-x" onclick="tempBuilderList.splice(${i}, 2); resetBuilderForm(); renderBuilder()">✖</span><div class="builder-click-zone" onclick="editBuilderItem(${i})" title="Cliquer pour modifier"><div style="margin-bottom:12px;"> <span class="builder-exo-name">${item.name}</span> <span class="builder-exo-info">${item.sets} x ${item.reps} reps</span> </div><div> <span class="builder-exo-name">${nextItem.name}</span> <span class="builder-exo-info">${nextItem.sets} x ${nextItem.reps} reps</span> </div></div></div>`; i++; 
            } else { 
                const dataJson = JSON.stringify({ type: 'solo', data: item });
                listDiv.innerHTML += `<div class="builder-item builder-item-solo ${editingClass}" data-json='${dataJson}'><span class="delete-x" onclick="tempBuilderList.splice(${i}, 1); resetBuilderForm(); renderBuilder()">✖</span><div class="builder-click-zone" onclick="editBuilderItem(${i})" title="Cliquer pour modifier"><span class="builder-exo-name">${item.name}</span> <span class="builder-exo-info">${item.sets} x ${item.reps} reps</span></div></div>`; 
            } 
        } 
    }

    function startEditProgram(btn, e) {
        e.stopPropagation(); const name = btn.getAttribute('data-name'); resetBuilderForm(); 
        tempBuilderList = JSON.parse(JSON.stringify(DB.progs[name])); 
        document.getElementById('newProgName').value = name;
        document.getElementById('builderArea').classList.remove('hidden'); renderBuilder(); document.getElementById('builderArea').scrollIntoView({behavior: 'smooth'}); document.getElementById('btnSaveProg').innerText = "Mettre à jour la Séance"; 
    }

    function sauvegarderProgrammeFinal() { 
        const pendingName = document.getElementById('buildExoName').value;
        if(pendingName.trim() !== "") { alert("Attention : Tu as un exercice en cours de saisie ! Ajoute-le ou efface le champ avant de sauvegarder."); return; }
        const name = document.getElementById('newProgName').value; 
        if(name && tempBuilderList.length > 0) { DB.progs[name] = tempBuilderList; localStorage.setItem('gym_v8_progs', JSON.stringify(DB.progs)); resetBuilderForm(); tempBuilderList = []; document.getElementById('newProgName').value = ''; renderBuilder(); updateSelectMenu(); renderProgramList(); toggleBuilder(); } 
    }

    // --- LE RESTE EST INCHANGÉ ---
    function deleteProg(name, e) { e.stopPropagation(); if(confirm("Supprimer ?")) { delete DB.progs[name]; localStorage.setItem('gym_v8_progs', JSON.stringify(DB.progs)); updateSelectMenu(); renderProgramList(); chargerInterface(); } }
    function updateSelectMenu() { const s = document.getElementById('selectProgram'); s.innerHTML = '<option value="" disabled selected>Choisir une Séance</option>'; Object.keys(DB.progs).forEach(k => s.innerHTML += `<option value="${k}">${k}</option>`); }
    function renderProgramList() { const div = document.getElementById('listeMesProgrammes'); div.innerHTML = ''; colorBag = [...allColors]; Object.keys(DB.progs).forEach(k => { let html = ` <div class="prog-item" onclick="toggleDetails('${k}')"> <span class="prog-title">${k}</span> <div class="prog-header-actions"><button class="btn-edit" data-name="${k}" onclick="startEditProgram(this, event)">Modifier</button><button class="btn-danger" onclick="deleteProg('${k.replace(/'/g, "\\'")}', event)">Supprimer</button></div> </div> <div id="details-${k}" class="prog-details-box">`; const exos = DB.progs[k]; for (let i = 0; i < exos.length; i++) { const e = exos[i]; if (e.isSuperset && exos[i+1] && exos[i+1].isSuperset) { const eNext = exos[i+1]; const duoColor = getNextColor(); html += `<div class="superset-wrapper" style="background: ${duoColor}20; border: 1px solid ${duoColor}50;">`; html += ` <div class="prog-line" style="border-left-color: ${duoColor}; border-bottom: none; padding-bottom: 5px;"> <span class="prog-line-name">${e.name}</span> <span class="prog-line-info">${e.sets} x ${e.reps} reps</span> </div>`; html += ` <div class="prog-line" style="border-left-color: ${duoColor}; padding-top: 5px;"> <span class="prog-line-name">${eNext.name}</span> <span class="prog-line-info">${eNext.sets} x ${eNext.reps} reps</span> </div>`; html += `</div>`; i++; } else { const soloColor = getNextColor(); html += `<div class="exo-wrapper" style="background: ${soloColor}20; border: 1px solid ${soloColor}50;"> <div class="prog-line" style="border-left-color: ${soloColor}"> <span class="prog-line-name">${e.name}</span> <span class="prog-line-info">${e.sets} x ${e.reps} reps</span> </div> </div>`; } } html += `</div>`; div.innerHTML += html; }); }
    function toggleDetails(id) { document.getElementById('details-'+id).classList.toggle('open'); }
    function switchTab(view, btn) { ['seance', 'progs', 'history'].forEach(v => document.getElementById('view-'+v).classList.add('hidden')); document.getElementById('view-'+view).classList.remove('hidden'); document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active')); btn.classList.add('active'); const titleEl = document.getElementById('mainTitle'); if(view === 'seance') titleEl.innerText = "Ma Séance"; if(view === 'progs') titleEl.innerText = "Mon Programme"; if(view === 'history') titleEl.innerText = "Mon Historique"; }
    function toggleBuilder() { const area = document.getElementById('builderArea'); if (!area.classList.contains('hidden')) { resetBuilderForm(); document.getElementById('newProgName').value = ''; tempBuilderList = []; renderBuilder(); document.getElementById('btnSaveProg').innerText = "Sauvegarder la Séance"; } area.classList.toggle('hidden'); }
    
    // --- INTEGRATION V86 : AFFICHAGE COMPACT ---
    function chargerInterface() { 
        const key = document.getElementById('selectProgram').value; const zone = document.getElementById('zoneTravail'); const btnZone = document.getElementById('zoneFinSeance'); zone.innerHTML = ''; btnZone.innerHTML = ''; currentSessionLogs = []; 
        if (!key) return; const exos = DB.progs[key]; colorBag = [...allColors]; 
        for(let i = 0; i < exos.length; i++) { 
            const exoA = exos[i]; const exoB = exos[i+1]; const color = getNextColor(); 
            if(exoA.isSuperset && exoB && exoB.isSuperset) { renderSuperset(zone, exoA, i, exoB, i+1, color, key); i++; } 
            else { renderNormal(zone, exoA, i, color, key); } 
        } 
        btnZone.innerHTML = `<button class="btn-terminate-session" onclick="terminerLaSeance('${key}')">Terminer la Séance</button>`; 
    }
    
    function createInputWithUnit(id, unit) { return `<div class="input-wrapper"><input type="number" id="${id}" placeholder="" min="0" oninput="this.value = Math.abs(this.value)"><span class="unit-label">${unit}</span></div>`; }
    function createDropInput(className, unit) { return `<div class="input-wrapper"><input type="number" class="${className}" placeholder="" min="0" oninput="this.value = Math.abs(this.value)"><span class="unit-label">${unit}</span></div>`; }
    
    // --- RENDER NORMAL AVEC NETTOYAGE V86 ---
    function renderNormal(container, exo, idx, color, progName) { 
        let html = `<div class="card" style="--card-color: ${color}; border-left-color: ${color}; animation-delay: ${idx * 0.1}s"><div class="card-header"><div class="header-top"><span class="exo-title">${exo.name}</span><span class="exo-badge">Fourchette de reps : ${exo.reps}</span></div></div><div id="sets_${idx}">`; 
        for(let s=1; s<=exo.sets; s++) { 
            let lastPerf = getLastPerf(exo.name, s, progName);
            // NETTOYAGE V86 : Remplacer "Dégressive:" par "+" et s'assurer que l'affichage est compact
            if (lastPerf) {
                lastPerf = lastPerf.replace(/ \+ Dégressive: /g, " + ").replace(/Dégressive: /g, "+ ");
                lastPerf = `<span class="last-perf">Précédent : ${lastPerf}</span>`;
            } else { lastPerf = ''; }

            html += `<div class="serie-container" id="container_${idx}_${s}"><div class="input-row"><div class="set-col"><div class="set-num">#${s}</div><button class="btn-mini-add" onclick="ajouterDegressive('${idx}_${s}')">+</button></div>${createInputWithUnit(`p_${idx}_${s}`, 'kg')}${createInputWithUnit(`r_${idx}_${s}`, 'reps')}</div>${lastPerf}</div>`; 
        } 
        html += `</div><button class="btn-finish-exo" id="btn_finish_${idx}" onclick="validerExerciceNormal('${exo.name}', ${idx}, ${exo.sets}, this, '${color}')">Exercice Fini</button></div>`; 
        container.innerHTML += html; 
    }
    
    // --- RENDER SUPERSET AVEC NETTOYAGE V86 ---
    function renderSuperset(container, exoA, idxA, exoB, idxB, color, progName) { 
        const max = Math.max(exoA.sets, exoB.sets); 
        let html = `<div class="card superset-container" style="--card-color: ${color}; border-left-color: ${color}; animation-delay: ${idxA * 0.1}s"><span class="superset-label" style="background:${color}">Superset</span><div class="card-header" style="border:none; padding-bottom:5px; margin-bottom:5px;"><div class="header-top"><span class="exo-title">A. ${exoA.name}</span> <span class="exo-badge">Fourchette de reps : ${exoA.reps}</span></div></div><div class="card-header"><div class="header-top"><span class="exo-title">B. ${exoB.name}</span> <span class="exo-badge">Fourchette de reps : ${exoB.reps}</span></div></div><div id="sets_super_${idxA}">`; 
        for(let s=1; s<=max; s++) { 
            let lastPerfA = getLastPerf(exoA.name, s, progName);
            if(lastPerfA) { lastPerfA = lastPerfA.replace(/ \+ Dégressive: /g, " + ").replace(/Dégressive: /g, "+ "); lastPerfA = `<span class="last-perf">Précédent : ${lastPerfA}</span>`; } else { lastPerfA = ''; }
            
            let lastPerfB = getLastPerf(exoB.name, s, progName);
            if(lastPerfB) { lastPerfB = lastPerfB.replace(/ \+ Dégressive: /g, " + ").replace(/Dégressive: /g, "+ "); lastPerfB = `<span class="last-perf">Précédent : ${lastPerfB}</span>`; } else { lastPerfB = ''; }

            html += `<div class="set-block"><div class="serie-container" id="container_${idxA}_${s}"><div class="input-row"><div class="set-col"><div class="set-num">A</div><button class="btn-mini-add" onclick="ajouterDegressive('${idxA}_${s}')">+</button></div>${createInputWithUnit(`p_${idxA}_${s}`, 'kg')}${createInputWithUnit(`r_${idxA}_${s}`, 'reps')}</div>${lastPerfA}</div><div class="serie-container" id="container_${idxB}_${s}"><div class="input-row"><div class="set-col"><div class="set-num">B</div><button class="btn-mini-add" onclick="ajouterDegressive('${idxB}_${s}')">+</button></div>${createInputWithUnit(`p_${idxB}_${s}`, 'kg')}${createInputWithUnit(`r_${idxB}_${s}`, 'reps')}</div>${lastPerfB}</div></div>`; 
        } 
        html += `</div><button class="btn-finish-exo" id="btn_finish_${idxA}" onclick="validerSuperset('${exoA.name}', ${idxA}, '${exoB.name}', ${idxB}, ${max}, this, '${color}')">Exercices Finis</button></div>`; 
        container.innerHTML += html; 
    }
    
    function ajouterDegressive(baseId) { const container = document.getElementById('container_' + baseId); const div = document.createElement('div'); div.className = 'input-row drop-row'; div.innerHTML = `<div class="set-col"><div class="drop-icon" onclick="this.closest('.drop-row').remove()" title="Supprimer">↳</div></div>${createDropInput('drop-weight', 'kg')}${createDropInput('drop-reps', 'reps')}`; container.appendChild(div); }
    
    // --- SAUVEGARDE COMPACTE V86 (" + ") ---
    function getDropsString(containerId) { const container = document.getElementById(containerId); let drops = []; container.querySelectorAll('.drop-row').forEach(row => { const w = row.querySelector('.drop-weight').value; const r = row.querySelector('.drop-reps').value; if(w && r) drops.push(`${w} kg x ${r} reps`); }); if(drops.length > 0) return " + " + drops.join(' + '); return ""; }
    
    function validerExerciceNormal(nomExo, idx, totalSets, btn, color) { if (btn.classList.contains('validated')) { btn.classList.remove('validated'); btn.innerText = "Exercice Fini"; btn.style.backgroundColor = "var(--btn-default-bg)"; btn.style.color = "var(--btn-default-text)"; btn.style.boxShadow = "none"; for(let s=1; s<=totalSets; s++) { document.getElementById(`p_${idx}_${s}`).disabled = false; document.getElementById(`r_${idx}_${s}`).disabled = false; const container = document.getElementById(`container_${idx}_${s}`); container.querySelectorAll('input').forEach(i => i.disabled = false); if(container.querySelector('.btn-mini-add')) container.querySelector('.btn-mini-add').style.display = 'flex'; container.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'block'); } currentSessionLogs = currentSessionLogs.filter(log => log.exo !== nomExo); return; } let savedCount = 0; let tempLogs = []; for(let s=1; s<=totalSets; s++) { const p = document.getElementById(`p_${idx}_${s}`).value; const r = document.getElementById(`r_${idx}_${s}`).value; if(p && r) { let dropText = getDropsString(`container_${idx}_${s}`); tempLogs.push({ exo: nomExo, perf: `${p} kg x ${r} reps${dropText}`, serie: s }); savedCount++; } } if(savedCount > 0) { currentSessionLogs.push(...tempLogs); btn.classList.add('validated'); btn.innerText = "Validé"; btn.style.backgroundColor = color; btn.style.color = "#fff"; for(let s=1; s<=totalSets; s++) { document.getElementById(`p_${idx}_${s}`).disabled = true; document.getElementById(`r_${idx}_${s}`).disabled = true; const container = document.getElementById(`container_${idx}_${s}`); container.querySelectorAll('input').forEach(i => i.disabled = true); if(container.querySelector('.btn-mini-add')) container.querySelector('.btn-mini-add').style.display = 'none'; container.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'none'); } } else { alert("Remplis au moins une série !"); } }
    function validerSuperset(nomA, idxA, nomB, idxB, totalSets, btn, color) { if (btn.classList.contains('validated')) { btn.classList.remove('validated'); btn.innerText = "Exercices Finis"; btn.style.backgroundColor = "var(--btn-default-bg)"; btn.style.color = "var(--btn-default-text)"; btn.style.boxShadow = "none"; for(let s=1; s<=totalSets; s++) { document.getElementById(`p_${idxA}_${s}`).disabled = false; document.getElementById(`r_${idxA}_${s}`).disabled = false; const cA = document.getElementById(`container_${idxA}_${s}`); cA.querySelectorAll('input').forEach(i => i.disabled = false); if(cA.querySelector('.btn-mini-add')) cA.querySelector('.btn-mini-add').style.display = 'flex'; cA.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'block'); document.getElementById(`p_${idxB}_${s}`).disabled = false; document.getElementById(`r_${idxB}_${s}`).disabled = false; const cB = document.getElementById(`container_${idxB}_${s}`); cB.querySelectorAll('input').forEach(i => i.disabled = false); if(cB.querySelector('.btn-mini-add')) cB.querySelector('.btn-mini-add').style.display = 'flex'; cB.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'block'); } currentSessionLogs = currentSessionLogs.filter(log => log.exo !== nomA && log.exo !== nomB); return; } let savedCount = 0; let tempLogs = []; for(let s=1; s<=totalSets; s++) { const pA = document.getElementById(`p_${idxA}_${s}`).value; const rA = document.getElementById(`r_${idxA}_${s}`).value; if(pA && rA) { let dropTextA = getDropsString(`container_${idxA}_${s}`); tempLogs.push({ exo: nomA, perf: `${pA} kg x ${rA} reps${dropTextA}`, serie: s }); savedCount++; } const pB = document.getElementById(`p_${idxB}_${s}`).value; const rB = document.getElementById(`r_${idxB}_${s}`).value; if(pB && rB) { let dropTextB = getDropsString(`container_${idxB}_${s}`); tempLogs.push({ exo: nomB, perf: `${pB} kg x ${rB} reps${dropTextB}`, serie: s }); savedCount++; } } if(savedCount > 0) { currentSessionLogs.push(...tempLogs); btn.classList.add('validated'); btn.innerText = "Validé"; btn.style.backgroundColor = color; btn.style.color = "#fff"; for(let s=1; s<=totalSets; s++) { document.getElementById(`p_${idxA}_${s}`).disabled = true; document.getElementById(`r_${idxA}_${s}`).disabled = true; const cA = document.getElementById(`container_${idxA}_${s}`); cA.querySelectorAll('input').forEach(i => i.disabled = true); if(cA.querySelector('.btn-mini-add')) cA.querySelector('.btn-mini-add').style.display = 'none'; cA.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'none'); document.getElementById(`p_${idxB}_${s}`).disabled = true; document.getElementById(`r_${idxB}_${s}`).disabled = true; const cB = document.getElementById(`container_${idxB}_${s}`); cB.querySelectorAll('input').forEach(i => i.disabled = true); if(cB.querySelector('.btn-mini-add')) cB.querySelector('.btn-mini-add').style.display = 'none'; cB.querySelectorAll('.drop-icon').forEach(icon => icon.style.display = 'none'); } } else { alert("Remplis au moins une série !"); } }
    
    function terminerLaSeance(progName) { if(currentSessionLogs.length === 0) return alert("Tu n'as rien validé !"); if(confirm("Confirmer la fin de la séance ?")) { const sessionObject = { id: Date.now(), date: new Date().toLocaleDateString(), programName: progName, details: currentSessionLogs }; DB.history.unshift(sessionObject); localStorage.setItem('gym_v21_history', JSON.stringify(DB.history)); currentSessionLogs = []; alert("Séance sauvegardée !"); document.getElementById('selectProgram').value = ""; document.getElementById('zoneTravail').innerHTML = ""; document.getElementById('zoneFinSeance').innerHTML = ""; historyState.view = 'categories'; historyState.selected = null; renderHistory(); } }
    
    function renderHistory() { 
        const container = document.getElementById('listeHistorique'); 
        const titleEl = document.getElementById('histMainTitle'); 
        const btnEl = document.getElementById('histActionBtn'); 
        container.innerHTML = ''; 
        if(DB.history.length === 0) { container.innerHTML = '<p style="text-align:center; color:#999; margin-top:20px">Aucune séance enregistrée.</p>'; return; } 
        
        if (historyState.view === 'categories') { 
            titleEl.innerText = "Types de Séances"; 
            btnEl.innerText = "Effacer toutes les Séances"; 
            btnEl.onclick = resetHistoryOnly; 
            const groups = {}; DB.history.forEach(s => { if(!groups[s.programName]) groups[s.programName] = 0; groups[s.programName]++; }); 
            Object.keys(groups).forEach(name => { const count = groups[name]; const btn = document.createElement('div'); btn.className = 'hist-category-btn'; btn.innerHTML = `<span class="hist-cat-title">${name}</span> <span class="hist-count">${count}</span>`; btn.onclick = () => { historyState.view = 'details'; historyState.selected = name; renderHistory(); }; container.appendChild(btn); }); 
        } else { 
            titleEl.innerText = "SÉANCES " + historyState.selected; 
            btnEl.innerText = "Effacer les Séances " + historyState.selected; 
            btnEl.onclick = () => deleteCategoryHistory(historyState.selected); 
            const backBtn = document.createElement('div'); backBtn.className = 'btn-back-hist'; backBtn.innerText = 'Retour aux types de Séances'; backBtn.onclick = () => { historyState.view = 'categories'; historyState.selected = null; renderHistory(); }; container.appendChild(backBtn); 
            const filtered = DB.history.filter(s => s.programName === historyState.selected); 
            filtered.forEach(session => { const wrapper = document.createElement('div'); wrapper.className = 'hist-session'; const header = document.createElement('div'); header.className = 'hist-header'; header.innerHTML = `<span class="hist-date-large">${session.date}</span>`; const body = document.createElement('div'); body.className = 'hist-body'; 
                // AFFICHAGE HISTORIQUE AVEC LE NETTOYAGE V86 EGALEMENT
                if(session.details && session.details.length > 0) { 
                    session.details.forEach(log => { 
                        // Nettoyage visuel de l'historique aussi
                        let cleanPerf = log.perf.replace(/ \+ Dégressive: /g, " + ").replace(/Dégressive: /g, "+ ");
                        body.innerHTML += `<div class="hist-exo-line"><span class="hist-exo-name">${log.exo} <small style="color:#b2bec3;">(#${log.serie})</small></span><span class="hist-exo-perf">${cleanPerf}</span></div>`; 
                    }); 
                } else { body.innerHTML = '<div style="padding:10px; color:#999">Pas de détails.</div>'; } 
                header.onclick = () => { body.classList.toggle('open'); }; wrapper.appendChild(header); wrapper.appendChild(body); container.appendChild(wrapper); 
            }); 
        } 
    }

    function resetHistoryOnly() { if(confirm("Effacer tout l'historique ?")) { DB.history = []; localStorage.setItem('gym_v21_history', JSON.stringify([])); historyState.view = 'categories'; renderHistory(); } }
    function deleteCategoryHistory(catName) { if(confirm("Effacer tout l'historique pour " + catName + " ?")) { DB.history = DB.history.filter(s => s.programName !== catName); localStorage.setItem('gym_v21_history', JSON.stringify(DB.history)); historyState.view = 'categories'; historyState.selected = null; renderHistory(); } }
    function activerModeSuperset() { document.getElementById('blockExoB').classList.remove('hidden'); document.getElementById('btnGroupNormal').classList.add('hidden'); document.getElementById('btnGroupSuperset').classList.remove('hidden'); document.getElementById('labelExoA').classList.remove('hidden'); }
    function annulerModeSuperset() { document.getElementById('blockExoB').classList.add('hidden'); document.getElementById('btnGroupNormal').classList.remove('hidden'); document.getElementById('btnGroupSuperset').classList.add('hidden'); document.getElementById('labelExoA').classList.add('hidden'); document.getElementById('buildExoNameB').value = ''; }
</script>

</body>
</html>